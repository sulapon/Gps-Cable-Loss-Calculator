<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>è¨ˆç®—å·¥å…·</title>
<meta name="theme-color" content="#071026">
<style>
  /* --- çµ±ä¸€åŸºç¤é¢¨æ ¼ --- */
  :root{
    --bg-0:#050a16; --bg-1:#0b1526;
    /* é¡è‰²å„ªåŒ–ï¼šæ¨™ç±¤æ›´äº®ï¼Œè¼”åŠ©æ–‡å­—æ›´æŸ”å’Œ */
    --muted:#a8b3c3; /* æŸ”å’Œç°è— */ 
    --label:#85c9ff; /* æ˜äº®è—è‰² */
    --title:#ffe58f; /* é»ƒé‡‘è‰²æ¨™é¡Œ */
    --value:#5ff0d5; /* é’ç¶ è‰² (ç·šæé é¢æ•¸å€¼é¡è‰²) */
    
    /* GPS/çµæœå€å¡Šä½¿ç”¨è—è‰²ç³» accent */
    --accent1:#5ff0d5; 
    --accent2:#79a8ff; /* è—è‰² */
    
    --orange-border: #ffaa00; /* æ©˜è‰²å¤–æ¡†é¡è‰² */
    --glass: rgba(255,255,255,0.06);
    --shadow: 0 4px 12px rgba(0,0,0,0.40);
    font-size:24px;
    
    /* GPS ç‰¹æœ‰é¡è‰²è®Šæ•¸ */
    --gps-error-border: #dc3545; 
    
    /* ç·šæé é¢æŒ‰éˆ•é¡è‰² */
    --rf-green-start: #36c74d; 
    --rf-green-end: #1e8030;
    --rf-green-border: #1e8030;
    --red-clear: #dd4444;

    /* ç´«è‰²é¸æ“‡æ¬„ä½é¡è‰² */
    --purple-accent: #bb66ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:0;
    background:linear-gradient(180deg,var(--bg-0),var(--bg-1));
    color:#e8eef5;
    font-family:Inter, 'Noto Sans TC', system-ui;
    line-height:1.3;
  }

  /* ç§»é™¤æ¨™é¡Œå¾Œï¼Œä¿æŒ header åº•éƒ¨é‚Šç•Œä»¥åˆ†éš”å…§å®¹ */
  header{
    padding: 0 10px; /* ç§»é™¤å‚ç›´ padding */
    background-color: var(--bg-1); 
    border-bottom: 1px solid rgba(255,255,255,0.08); 
    height: 0; /* ç§»é™¤é«˜åº¦ */
  } 

  h1{
    /* H1 æ¨™ç±¤å…§å®¹å·²ç§»é™¤ */
    display: none; 
  }

  main{padding:6px; max-width:880px; margin:0 auto;}

  .card{
    background:rgba(255,255,255,0.02);
    padding:6px 8px;
    border-radius:10px;
    /* ç¸®å°å¡ç‰‡é–“éš” (ç¶­æŒä¸è®Šæˆ–å¾®èª¿) */
    margin-bottom:6px; 
    box-shadow:var(--shadow);
    border:1px solid rgba(255,255,255,0.03);
  }
  
  /* é‡å° GPS é é¢ä¸»å¡ç‰‡çš„å…§é‚Šè·é€²è¡Œæ”¾å¤§ (4px * 1.3 â‰ˆ 5.2px) */
  .gps-container .card {
    padding: 5px 8px; /* æ”¾å¤§ */
  }

  .section-title{
    color:var(--title);
    font-size:18px;
    font-weight:700;
    /* ç¸®å°æ¨™é¡Œä¸‹é–“éš” (ç¶­æŒä¸è®Šæˆ–å¾®èª¿) */
    margin-bottom:4px; 
    display:block;
  }
  
  /* --- RF é ‚éƒ¨æ¨™é¡Œå’Œå–®ä½é¸æ“‡å™¨çš„å®¹å™¨æ¨£å¼ --- */
  .rf-header {
      margin-bottom: 6px;
  }
  
  /* ç¢ºä¿ section-title åœ¨æ–°çš„ä½ç½®æ­£ç¢ºé¡¯ç¤º */
  .rf-header .section-title {
    color: var(--title);
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 2px; 
    display: block;
  }

  /* è™•ç†å–®ä½é¸æ“‡å™¨çš„ä½ˆå±€ (ä½¿å…¶åœ¨ä¸€è¡Œ) */
  .unit-selector-row {
    display: flex;
    align-items: center;
    justify-content: flex-start; 
    gap: 8px; 
    padding: 4px 0;
    margin-bottom: 2px;
  }

  .unit-selector-row .unit-label {
    font-size: 15px; 
    color: var(--label);
    margin-bottom: 0;
    font-weight: 700; 
  }
  /* --- çµæŸæ–°å¢ --- */

  .form-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:5px;
    align-items:end;
  }

  label{
    color:var(--label);
    font-size:15px;
    margin-bottom:1px;
    display:block;
  }

  /* è¼¸å…¥æ¡†èˆ‡é¸æ“‡å™¨é¢¨æ ¼çµ±ä¸€ */
  input,select{
    width:100%;
    padding:5px 8px;
    font-size:17px;
    color:var(--value);
    background:transparent;
    border-radius:6px;
    border:1px solid rgba(255,255,255,0.15); 
  }
  
  /* --- RF è¼¸å…¥æ¬„ä½å°ˆç”¨æ¸…é™¤æŒ‰éˆ• (å¯¦ç¾é å³å°é½Š) --- */
  .input-with-clear-rf {
    display: flex;
    align-items: center;
    position: relative; 
  }

  /* è®“è¼¸å…¥æ¡†å¡«æ»¿ç©ºé–“ä¸¦ç‚ºæŒ‰éˆ•é ç•™ç©ºé–“ */
  .input-with-clear-rf input {
    flex-grow: 1; 
    padding-right: 35px; 
  }

  .clear-btn-rf {
    position: absolute;
    right: 0; 
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--red-clear); /* ä½¿ç”¨çµ±ä¸€çš„ç´…è‰² */
    font-size: 18px;
    cursor: pointer;
    padding: 0 8px; 
    line-height: 1;
    font-weight: bold;
    opacity: 0.8;
    z-index: 10;
    /* é¿å…æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡†çš„é‚Šç•Œè¡çª */
    height: 100%; 
    display: flex;
    align-items: center;
  }
  /* --- çµæŸæ–°å¢ --- */

  /* RF å–®ä½é¸æ“‡æ¬„ä½èˆ‡ GPS é¡¯ç¤ºæ ¼å¼é¸æ“‡æ¬„ä½æ”¹æˆç´«è‰² */
  #unit, #displayMode {
      border: 1px solid var(--purple-accent) !important;
      color: var(--purple-accent) !important;
      /* å¯é¸ï¼šå¢åŠ æ·ºç´«è‰²èƒŒæ™¯ */
      background-color: rgba(187, 102, 255, 0.08) !important; 
      
      /* èª¿æ•´ #unit é¸æ“‡æ¡†çš„æ¨£å¼ï¼Œä½¿å…¶æ›´é©åˆåœ¨ä¸€è¡Œä¸­ */
      width: auto !important; 
      max-width: 120px !important;
      padding: 3px 6px !important; /* ç¨å¾®ç¸®å°å…§é‚Šè· */
      font-size: 15px !important; 
      flex-shrink: 0;
  }

  .gps-container input[type="number"], .gps-container input[type="text"] {
    padding: 3px 5px;
    font-size: 14px;
    border: 1px solid rgba(255,255,255,0.2); 
  }


  .controls{
    margin-top:2px;
    display:flex;
    gap:5px;
  }

  /* æŒ‰éˆ•é¢¨æ ¼çµ±ä¸€ (é è¨­ç‚º GPS çš„è—è‰²æ¼¸å±¤) */
  .btn{
    background:linear-gradient(90deg,var(--accent1),var(--accent2));
    border:0;
    padding:5px 8px;
    border-radius:6px;
    font-weight:700;
    font-size:16px;
    color:#022;
    cursor:pointer;
  }
  .btn.ghost{
    border:1px solid var(--accent2); /* è—è‰²ç³»é‚Šæ¡† */
    background:transparent;
    color:#e8eef5;
  }
  .btn.clear{
    background:var(--red-clear);
    color:white;
    border-radius:6px;
  }

  /* ç·šæé é¢æŒ‰éˆ•ç¶ è‰²æ¨£å¼ (è¦†è“‹) */
  #rf-content + .btn-row .btn {
      background: linear-gradient(90deg, var(--rf-green-start), var(--rf-green-end)); /* ç¶ è‰²æ¼¸å±¤ */
      color: #022; 
      border: none;
  }
  #rf-content + .btn-row .btn.ghost {
      background: transparent;
      border: 1px solid var(--rf-green-border); /* ç¶ è‰²é‚Šæ¡† */
      color: #e8eef5;
  }
  #rf-content + .btn-row .btn.clear {
      background: var(--red-clear); /* ç¶­æŒç´…è‰² */
      color: white;
      border: none;
  }


  /* è¨ˆç®—æŒ‰éˆ•è¡Œ */
  .btn-row{ 
    display:flex; flex-wrap:nowrap; justify-content:space-between; align-items:center; gap:12px; width:100%; box-sizing:border-box; 
  }
  .btn-row .btn{ 
    flex:1 1 0; text-align:center; white-space:nowrap; 
  }

  #liveInputs{
    margin-top:3px;
    font-size:14px;
    color:var(--muted);
  }

  /* è¡¨æ ¼é¢¨æ ¼çµ±ä¸€ */
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:6px;
    font-size:16px;
  }
  thead th{
    color:var(--label);
    padding:3px 3px;
    border-bottom:1px solid rgba(255,255,255,0.06);
    text-align:center;
  }
  tbody td{
    padding:4px 3px;
    border-bottom:1px solid rgba(255,255,255,0.03);
    text-align:center;
  }

  .name{
    color:#ffd369; 
    font-weight:700;
    white-space:nowrap;
  }
  th:first-child, td:first-child{
    width:32%;
    text-align:left;
  }

  /* ç·šæé é¢æ•¸å€¼é¡è‰² (é’ç¶ è‰²) */
  .value, .percent{
    color:var(--value);
    font-weight:800;
    font-variant-numeric:tabular-nums;
  }

  .small-note{
    font-size:13px;
    margin-top:3px;
    color:var(--muted);
  }

  @media (max-width:640px){
    .form-grid{grid-template-columns:1fr;}
  }
  
  /* --- å°è¦½åˆ— (Tabs) æ¨£å¼ --- */
  .tabs{
    display:flex;
    margin-bottom: 6px;
    overflow-x: auto;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .tab-button{
    flex-shrink: 0;
    padding: 8px 15px;
    margin: 0 4px;
    background: transparent;
    border: 0;
    color: var(--muted);
    font-size: 16px;
    cursor: pointer;
    font-weight: 600;
    border-radius: 8px 8px 0 0;
    transition: all 0.2s ease;
  }
  .tab-button.active{
    background: var(--glass);
    color: var(--title);
    border-bottom: 2px solid var(--accent1);
  }
  .tab-content{
    display: none;
    padding-top: 5px;
  }
  .tab-content.active{
    display: block;
  }
  
  /* ==================================== */
  /* --- GPS è¨ˆç®—å™¨å„ªåŒ–æ¨£å¼ (æ”¾å¤§é–“éš”) --- */
  /* ==================================== */
  .gps-container { padding: 0; }
  /* ç¸®å°æç¤ºæ–‡å­—é–“è· (1px * 1.3 â‰ˆ 1.3px) */
  .gps-tip { color: var(--label) !important; font-size: 13px !important; margin: 0 0 2px 0 !important; }
  
  /* ç¸®å°æ¨¡å¼é¸æ“‡å™¨ä¸Šé–“è· (2px * 1.3 â‰ˆ 2.6px) */
  .display-mode-container { margin-top: 3px; } 

  /* ç¸®å°å€å¡Šå…§å¤–é‚Šè· */
  .gps-ig { 
    /* æ”¾å¤§å€å¡Šé–“è· (1px * 1.3 â‰ˆ 1.3px) */
    margin-bottom: 2px !important; 
    /* æ”¾å¤§å…§é‚Šè· (2px * 1.3 â‰ˆ 2.6px; 5px * 1.3 â‰ˆ 6.5px) */
    padding: 3px 7px !important; 
    border: 1px solid rgba(255,255,255,0.05); 
    border-radius: 8px; 
    background-color: rgba(255,255,255,0.02); 
  }
  
  /* ç¸®å°é ­éƒ¨å’Œå…§å®¹é–“è· */
  .gps-loc-header { 
    /* æ”¾å¤§æ¨™é¡Œä¸‹é–“è· (0px -> 2px) */
    margin-bottom: 2px !important; 
    font-weight: bold; 
    color: var(--title); 
    font-size: 17px; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
  }
  /* å³å´çš„åœ°åè¼¸å…¥/æ¸…é™¤æŒ‰éˆ•ç¾¤çµ„ */
  .gps-loc-header > div {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  /* åœ°åè¼¸å…¥æ¡† */
  #nameA, #nameB {
    width: 144px !important;
    max-width: 144px !important; 
    font-size: 14px !important; 
    text-align: center; 
    flex-shrink: 0; 
    padding: 4px 6px !important; /* ç¨å¾®æ”¾å¤§ */
  }
  /* åœ°åæ¨™ç±¤ (åœ°å) */
  .gps-loc-header span { color: var(--muted); font-size: 13px; flex-shrink: 0; }
  
  /* ç¸®å°åº§æ¨™çµ„çš„å…§å¤–é‚Šè· */
  .gps-cg { 
    /* æ”¾å¤§å…§é‚Šè· (1px * 1.3 â‰ˆ 1.3px) */
    padding: 2px !important; 
    /* æ”¾å¤§å¤–é‚Šè· (0px -> 2px) */
    margin-bottom: 2px !important; 
    border: 1px solid rgba(255,255,255,0.05); 
    border-radius: 6px; 
  }
  /* ç¸®å°æ¨™ç±¤ä¸‹æ–¹çš„é–“è·ï¼Œç¨å¾®ç¸®å°å­—é«”ä¿æŒç·Šæ¹Šæ„Ÿ */
  .gps-cl { 
    font-weight: bold; 
    color: var(--label); 
    display: block; 
    /* æ”¾å¤§é–“è· (0px -> 1px) */
    margin-bottom: 1px; 
    font-size: 14px !important; 
  }

  /* ç§»é™¤ DD è¡Œé–“è· */
  .gps-ddr { 
    display: flex; 
    align-items: center; 
    margin-bottom: 0 !important; 
  }
  .gps-ddr input { 
    flex-grow: 1; 
    text-align: right; 
    padding: 4px 8px !important; /* æ”¾å¤§è¼¸å…¥æ¡† padding (3px * 1.3 â‰ˆ 3.9px; 6px * 1.3 â‰ˆ 7.8px) */
    font-size: 16px !important;
  } 
  .gps-ddr span { 
    color: var(--muted); 
    font-size: 14px !important; 
    margin-right: 4px; 
    flex-shrink: 0; 
  }
  
  /* ç§»é™¤ DMS è¡Œé–“è· */
  .gps-dmsr { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    gap: 4px; 
    margin-bottom: 0 !important; 
  }
  .gps-dmsr input { 
    padding: 4px 8px !important; /* æ”¾å¤§è¼¸å…¥æ¡† padding */
    font-size: 16px !important;
  }
  .gps-dmsf { display: flex; align-items: center; flex: 1; min-width: 0; }
  .gps-dmsf input { text-align: center; margin-right: 3px; max-width: none; flex-grow: 1; min-width: 30px; } 
  .gps-dmsf:nth-child(1) input { flex: 2; } 
  .gps-dmsf:nth-child(2) input { flex: 1.5; } 
  .gps-dmsf:nth-child(3) input { flex: 2.5; } 
  .gps-dmsr span { color: var(--muted); font-size: 14px !important; margin-right: 0; flex-shrink: 0; }
  
  /* ç¸®å°é«˜åº¦è¡Œçš„é–“è· */
  .gps-er { 
    display: flex; 
    align-items: center; 
    justify-content: flex-start; 
    gap: 5px; 
    /* æ”¾å¤§ä¸Šé–“è· (1px * 1.3 â‰ˆ 1.3px) */
    margin-top: 2px !important; 
    /* æ”¾å¤§å…§é‚Šè· (1px * 1.3 â‰ˆ 1.3px) */
    padding-top: 2px !important; 
    border-top: 1px dashed rgba(255,255,255,0.08); 
  }
  .gps-er label { 
    font-size: 15px !important; 
    flex-shrink: 0; 
    color: var(--label); 
    width: 120px; 
    margin-right: 8px;
  } 
  .gps-er input { 
    text-align: right; 
    flex-grow: 1; 
    padding: 4px 8px !important; /* æ”¾å¤§è¼¸å…¥æ¡† padding */
    font-size: 16px !important;
  }

  /* å–®ä½ (å…¬å°º (m)) + X æŒ‰éˆ•çš„å®¹å™¨ */
  .gps-er > .control-group {
      display: flex;
      align-items: center; 
      flex-shrink: 0;
      min-width: 0;
      /* é—œéµä¿®æ”¹: ä½¿ç”¨ margin-left: auto å°‡æ•´å€‹æ§åˆ¶çµ„æ¨åˆ°æœ€å³é‚Š */
      margin-left: auto !important; 
  }
  .gps-er .control-group span { 
    font-size: 14px !important; 
    flex-shrink: 0; 
    color: var(--muted); 
    margin-left: 4px; 
  }


  /* æ¸…é™¤æŒ‰éˆ• (GPS) - èª¿æ•´æ¨£å¼ */
  .gps-cb { 
    background: none; 
    border: none; 
    color: #ff6347; 
    font-size: 18px; 
    cursor: pointer; 
    padding: 0 5px; 
    line-height: 1; 
    font-weight: bold; 
    opacity: 0.9;
    margin: 0; 
    flex-shrink: 0; 
  }
  
  /* é‡å°ç·¯åº¦/ç¶“åº¦ (DD) æ¬„ä½ä¸­çš„æŒ‰éˆ•ï¼Œå·²ç¶“æœ‰ margin-left: auto é å³ */
  .gps-ddr .gps-cb {
      margin-left: auto; 
  }
  /* ç§»é™¤é‡å°é«˜åº¦æ¬„ä½æŒ‰éˆ•çš„é¡å¤– marginï¼Œç¢ºä¿åªä¿ç•™å’Œå–®ä½çš„é–“è· */
  .gps-er .control-group .gps-cb {
      margin-left: 5px !important; 
  }
  
  /* GPS çµæœé¡¯ç¤º */
  #gpsRes { 
    /* æ”¾å¤§çµæœå€å¡Šä¸Šé–“è· (4px * 1.3 â‰ˆ 5.2px) */
    margin-top: 5px !important; 
    /* æ”¾å¤§å…§é‚Šè· (6px * 1.3 â‰ˆ 7.8px) */
    padding: 8px !important; 
    border: 2px solid var(--accent2); 
    border-radius: 8px; 
    background-color: rgba(121, 168, 255, 0.05); 
    font-size: 16px !important; 
    font-weight: 500; 
    text-align: left; 
    color: #e8eef5; 
  }
  /* ç¸®å°çµæœè¡Œçš„è¡Œè· (3px * 1.3 â‰ˆ 3.9px) */
  #gpsRes p { margin: 4px 0 !important; } 

  /* GPS çµæœæ¨™ç±¤æ–‡å­—å„ªåŒ– (é»ƒé‡‘è‰² for labels) */
  .gps-label-title {
      color: var(--title); 
      font-weight: 700;
      margin-right: 5px;
  }
  
  /* GPS çµæœæ•¸å€¼é¡è‰²èˆ‡å¤§å° - ä¿®æ­£ï¼šæ”¹ç‚ºå’Œç·šæé é¢æ•¸å€¼ä¸€è‡´çš„é¡è‰² (var(--value)) */
  .v-dist, .v-bearing, .v-pitch-value {
    font-weight: 900 !important;
    font-size: 1.1em;
    color: var(--value) !important; 
  }

  /* --- GPS é¡¯ç¤ºæ ¼å¼ä¿®æ”¹æ¨£å¼ --- */
  .display-mode-container {
    display: flex;
    align-items: center; 
    justify-content: flex-start; 
    gap: 8px; 
    /* æ”¾å¤§ä¸Šé–“è· (2px * 1.3 â‰ˆ 2.6px) */
    margin-top: 3px; 
  }

  /* èª¿æ•´é¸æ“‡å™¨å¯¬åº¦ */
  #displayMode {
    width: auto !important; 
    max-width: 170px; 
    flex-shrink: 0; 
  }

  /* ç§»é™¤åŸå…ˆçš„ label æ¨™ç±¤ï¼Œæ”¹ç”¨ span */
  .display-mode-container label {
    display: none; 
  }
  /* æ–°å¢çš„æ–‡å­—å®¹å™¨ - ä¿æŒé å·¦ */
  .display-mode-text {
    font-weight: 700;
    color: var(--label);
    font-size: 14px;
    flex-shrink: 0;
  }

  /* --- ç·šæè¨ˆç®—çµæœå€å¡Šå¤–æ¡†æ¨£å¼ (è—è‰²) --- */
  .results-card-border {
    /* ç¹¼æ‰¿ #gpsRes çš„é‚Šæ¡†å’ŒèƒŒæ™¯æ¨£å¼ */
    border: 2px solid var(--accent2) !important; 
    border-radius: 8px !important; 
    background-color: rgba(121, 168, 255, 0.05) !important; 
  }

  /* --- æ©˜è‰²å¤–æ¡†æ¨£å¼ --- */
  .orange-border-card {
    border: 2px solid var(--orange-border) !important; 
    border-radius: 8px !important; 
    background-color: rgba(255, 170, 0, 0.05) !important; /* æŸ”å’Œçš„æ©˜è‰²èƒŒæ™¯ */
  }

</style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a4cff">
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>


<style>
  /* --- çµ±ä¸€åŸºç¤é¢¨æ ¼ --- */
  :root{
    --bg-0:#050a16; --bg-1:#0b1526;
    --muted:#a8b3c3; 
    --label:#85c9ff; 
    --title:#ffe58f; 
    --value:#5ff0d5; 
    
    --accent1:#5ff0d5; 
    --accent2:#79a8ff; 
    
    --orange-border: #ffaa00; 
    --red-clear: #dd4444; 
    --purple-accent: #bb66ff;
    
    --glass: rgba(255,255,255,0.06);
    --shadow: 0 4px 12px rgba(0,0,0,0.40);
    font-size:22px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:0;
    background:linear-gradient(180deg,var(--bg-0),var(--bg-1));
    color:#e8eef5; /* ä¸»è¦æ–‡å­—é¡è‰² (ç™½è‰²ï¼Œç”¨ä½œçµæœå–®ä½é¡è‰²) */
    font-family:Inter, 'Noto Sans TC', system-ui;
    line-height:1.3;
  }

  header{
    padding: 0 10px;
    background-color: var(--bg-1); 
    border-bottom: 1px solid rgba(255,255,255,0.08); 
    height: 0;
  } 

  h1{
    display: none; 
  }

  main{padding:6px; max-width:880px; margin:0 auto;}

  .card{
    background:rgba(255,255,255,0.02);
    padding:6px 8px;
    border-radius:10px;
    margin-bottom:6px; 
    box-shadow:var(--shadow);
    border:1px solid rgba(255,255,255,0.03);
  }
  
  /* --- æ–°å¢å€å¡Šæ¨™é¡Œæ§åˆ¶å€å¡Šæ¨£å¼ --- */
  .section-header-with-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px; /* Maintain previous section-title margin */
  }
  
  .section-header-with-controls .section-title {
    margin-bottom: 0; /* Move margin to the container */
  }
  
  .section-header-with-controls .btn-group {
    display: flex;
    gap: 5px;
    flex-shrink: 0;
  }
  /* --- æŒ‰éˆ•åŸºç¤æ¨£å¼ (åƒè€ƒ index.html) --- */
  .btn{
      padding: 5px 8px; 
      border-radius: 6px;
      font-weight: 700;
      font-size: 16px; 
      color: #022; 
      cursor: pointer;
      border: none;
      background: linear-gradient(90deg,var(--accent1),var(--accent2)); /* é è¨­ç‚ºè¨ˆç®—æŒ‰éˆ•æ¼¸å±¤ */
  }
  /* å€å¡Šæ¨™é¡ŒæŒ‰éˆ•å°ºå¯¸èª¿æ•´ */
  .section-header-with-controls .btn {
      padding: 3px 6px; 
      font-size: 14px; 
      border-radius: 4px;
      white-space: nowrap;
  }
  /* é è¨­æŒ‰éˆ•æ¨£å¼ (Ghost style) */
  .btn-reset {
      border: 1px solid var(--accent2); /* Accent2: Blue */
      background: transparent;
      color: #e8eef5;
  }
  /* æ¸…é™¤æŒ‰éˆ•æ¨£å¼ (Clear style) */
  .btn-clear {
      background: var(--red-clear);
      color: white;
      border: none;
  }
  /* --- çµæŸæ–°å¢ --- */

  .section-title{
    color:var(--title);
    font-size:17px;
    font-weight:700;
    margin-bottom:4px; 
    display:block;
  }
  
  .rf-header {
      margin-bottom: 6px;
  }
  
  .los-point-title {
    color: var(--title);
    font-size: 1.1em;
    font-weight: 700;
    margin-top: 10px;
    margin-bottom: 5px;
    border-bottom: 1px dashed rgba(255,255,255,0.08);
    padding-bottom: 3px;
  }

  label{
    color:var(--label);
    font-size:17px;
    margin-bottom:1px;
    display:block;
  }

  /* é€šç”¨è¼¸å…¥æ¡†èˆ‡é¸æ“‡å™¨é¢¨æ ¼ */
  input,select{
    width:100%;
    padding:5px 8px;
    font-size:17px;
    color:var(--value);
    background:transparent;
    border-radius:6px;
    border:1px solid rgba(255,255,255,0.15); 
  }
  
  /* --- å¸¶æœ‰æ¸…é™¤æŒ‰éˆ•çš„è¼¸å…¥å®¹å™¨ --- */
  .input-with-clear {
      display: flex;
      align-items: center;
      gap: 5px; 
      margin-bottom: 5px; 
  }
  .input-with-clear input {
      flex-grow: 1;
      width: auto; 
  }

  .clear-button {
      background: transparent;
      border: none;
      color: var(--red-clear); 
      font-size:22px;
      font-weight: bold;
      cursor: pointer;
      padding: 5px 0;
      line-height: 1;
      width: 30px; 
      flex-shrink: 0;
      border-radius: 4px;
      transition: background-color 0.2s;
  }
  .clear-button:hover {
      background-color: rgba(221, 68, 68, 0.2);
  }

  /* å–®ä½/åƒæ•¸é¸æ“‡æ¬„ä½æ¨£å¼ */
  #power_unit, #matching_unit, #link_tx_power_unit {
      border: 1px solid var(--purple-accent) !important;
      color: var(--purple-accent) !important;
      background-color: rgba(187, 102, 255, 0.08) !important; 
      width: 100% !important; 
      max-width: none !important; 
      padding: 5px 8px !important; 
      font-size: 17px !important; 
      flex-shrink: 0;
  }
  /* é‡æ–°å®šç¾©å–®ä½é¸æ“‡å™¨çš„é–“è· */
  #power_unit, #link_tx_power_unit {
      margin-bottom: 8px; 
  }


  /* --- æ©˜è‰²è¼¸å…¥æ¬„ä½å¤–æ¡† --- */
  .input-group-border {
    border: 2px solid var(--orange-border) !important; 
    border-radius: 8px !important; 
    background-color: rgba(255, 170, 0, 0.05) !important; 
    padding: 10px 12px; 
    margin-bottom: 8px; 
    margin-top: 5px; 
  }

  /* ç§»é™¤é‚Šæ¡†å…§ç¬¬ä¸€å€‹å…ƒç´ çš„ä¸Šé‚Šè·ï¼Œä½¿å…¶å…§å®¹è²¼é½Šé ‚éƒ¨ */
  .input-group-border > :first-child {
      margin-top: 0 !important;
  }
  
  /* èª¿æ•´ input-with-clear åœ¨é‚Šæ¡†å…§æ™‚çš„é–“è· */
  .input-group-border .input-with-clear {
      margin-bottom: 8px; 
  }
  /* ç§»é™¤é‚Šæ¡†å…§æœ€å¾Œä¸€å€‹ input-with-clear çš„ä¸‹é‚Šè· */
  .input-group-border .input-with-clear:last-child {
      margin-bottom: 0; 
  }
  
  /* èª¿æ•´ LOS/Link Budget å…§æ¨™é¡Œåœ¨é‚Šæ¡†å…§æ™‚çš„é–“è· */
  .input-group-border .los-point-title {
      margin-top: 8px;
  }
  /* ç¢ºä¿ç¬¬ä¸€å€‹ los-point-title è²¼é½Šé ‚éƒ¨ */
  .input-group-border .los-point-title:first-child {
      margin-top: 0 !important;
      margin-bottom: 5px;
  }


  /* --- 4/5/6. è¼¸å…¥æ¬„ä½å–®åˆ—é¡¯ç¤º (å¼·åˆ¶å †ç–Š) --- */
  .los-input-container {
      display: block; 
      gap: 0; 
      margin-bottom: 0 !important; 
  }
  .los-input-container .input-item {
      width: 100%; 
      flex: none; 
      min-width: auto;
      box-sizing: border-box;
      padding-bottom: 8px; 
      border-bottom: 1px dotted rgba(255,255,255,0.05); 
      margin-bottom: 8px; 
  }
  .los-input-container .input-item:last-child {
      padding-bottom: 0; 
      border-bottom: none; 
      margin-bottom: 0; 
  }


  /* çµæœé¡¯ç¤ºå€å¡Š */
  .results-card-border {
    border: 2px solid var(--accent2) !important; 
    border-radius: 8px !important; 
    background-color: rgba(121, 168, 255, 0.05) !important; 
    padding: 10px 12px; 
    margin-top: 8px !important; 
  }

  .result-value {
      color: var(--value); 
      font-weight: 900;
      font-size: 1.1em;
  }
  .result-value-small {
      font-size: 1em !important; 
  }
  
  /* åŠŸèƒ½åˆ‡æ›é¸æ“‡å™¨æ¨£å¼ */
  .function-selector-container {
      margin-bottom: 10px; 
      padding: 6px 8px;
      background: rgba(255,255,255,0.02);
      border-radius: 10px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.03);
  }
  #function_selector {
      border: 1px solid var(--accent1) !important;
      color: var(--accent1) !important;
      background-color: rgba(95, 240, 213, 0.08) !important; 
      font-weight: 700;
      font-size: 18px;
      margin-top: 4px;
  }
</style>
</head>
<body>

<header></header>

<main>

  <div class="tabs">
    <button class="tab-button active" data-tab="rftool" onclick="showTab('rftool')">ğŸ“¡ RFè¨ˆç®—å·¥å…·</button>
    <button class="tab-button" data-tab="rf" onclick="showTab('rf')">ã€°ï¸ ç·šæ</button>
    <button class="tab-button" data-tab="gps" onclick="showTab('gps')">ğŸŒ GPS</button>
</div>

  <div id="rf-content" class="tab-content">
    
    <div class="rf-header">
      <div class="section-title">TIMES ç·šæè¨ˆç®—</div>
      
      <div class="unit-selector-row">
        <label for="unit" class="unit-label">é•·åº¦å–®ä½ï¼š</label> 
        <select id="unit">
          <option value="m">å…¬å°º (m)</option>
          <option value="ft">è‹±å°º (ft)</option>
        </select>
      </div>
    </div>
    
    <section class="card orange-border-card" style="margin-top: 6px;">
      <div class="form-grid">
        <div>
          <label for="freq">é »ç‡ (MHz)</label>
          <div class="input-with-clear-rf">
            <input id="freq" type="number" value="900" min="0" step="1">
            <button class="clear-btn-rf" onclick="clearRfInput('freq')">âœ–</button>
          </div>
        </div>

        <div>
          <label for="lenInput">é•·åº¦</label>
          <div class="input-with-clear-rf">
            <input id="lenInput" type="number" value="10" min="0" step="0.01">
            <button class="clear-btn-rf" onclick="clearRfInput('lenInput')">âœ–</button>
          </div>
        </div>
        
        </div>
      
      <div id="liveInputs" class="small-note">è¼¸å…¥ä¸¦æŒ‰ã€Œè¨ˆç®—ã€æŸ¥çœ‹çµæœã€‚</div>
    </section>

    <div class="btn-row" style="margin-top: 6px; margin-bottom: 6px;">
        <button id="calc" class="btn" onclick="compute()">è¨ˆç®—</button>
        <button id="reset" class="btn ghost" onclick="resetRf()">é è¨­</button>
        <button id="clear" class="btn clear" onclick="clearRf()">æ¸…é™¤</button>
    </div>

    <section class="card results-card-border">
      <span class="section-title">è¨ˆç®—çµæœï¼ˆç”±å°åˆ°å¤§ï¼‰</span>
      <div id="tableArea"></div>
    </section>
  </div>

  <div id="gps-content" class="tab-content gps-container">
    <div class="card">
      <h2 class="section-title" style="margin-top: 0;">å…©é»GPS è·é›¢ã€æ–¹ä½è§’èˆ‡ä¿¯ä»°è§’è¨ˆç®—</h2>
      <p class="gps-tip">è€ƒæ…®åœ°çƒæ›²ç‡èˆ‡é«˜åº¦å·® (WGS84)</p>
      
      <div class="display-mode-container">
        <span class="display-mode-text">é¡¯ç¤ºæ ¼å¼</span>
        <select id="displayMode" style="padding:6px;border-radius:6px;font-size:14px;">
          <option value="decimal">åº¦ â€” åé€²åˆ¶ (DD)</option>
          <option value="dms">åº¦åˆ†ç§’ (DMS)</option>
        </select>
      </div>
    
      <div class="gps-ig orange-border-card">
          <div class="gps-loc-header">
              ğŸ“ åœ°é» A åº§æ¨™
              <div style="display: flex; align-items: center; gap: 5px;">
                  <input type="text" id="nameA" placeholder="åœ°å A" maxlength="5">
                  <span>(åœ°å)</span>
                  <button class="gps-cb" onclick="clearNameOnly('A')">âœ–</button> 
              </div>
          </div>
          
          <div class="gps-cg">
              <span class="gps-cl">ç·¯åº¦ (Latitude) - åé€²åˆ¶/DMS</span>
              <div class="gps-ddr">
                  <input type="number" id="latA" placeholder="åé€²åˆ¶æ•¸å€¼" step="0.000001">
                  <span>(åº¦)</span>
                  <button class="gps-cb" onclick="clearCoord('latA')">âœ–</button>
              </div>
              <div class="gps-dmsr">
                  <div class="gps-dmsf"><input type="number" id="latA_deg" placeholder="åº¦" oninput="dmsToD('latA')"><span>(åº¦)</span></div>
                  <div class="gps-dmsf"><input type="number" id="latA_min" placeholder="åˆ†" oninput="dmsToD('latA')"><span>(åˆ†)</span></div>
                  <div class="gps-dmsf"><input style="min-width:60px;" type="number" id="latA_sec" placeholder="ç§’" step="0.01" oninput="dmsToD('latA')"><span>(ç§’)</span></div>
                  <button class="gps-cb" onclick="clearCoord('latA')">âœ–</button> </div>
          </div>
          
          <div class="gps-cg">
              <span class="gps-cl">ç¶“åº¦ (Longitude) - åé€²åˆ¶/DMS</span>
              <div class="gps-ddr">
                  <input type="number" id="lonA" placeholder="åé€²åˆ¶æ•¸å€¼" step="0.000001">
                  <span>(åº¦)</span>
                  <button class="gps-cb" onclick="clearCoord('lonA')">âœ–</button>
              </div>
              <div class="gps-dmsr">
                  <div class="gps-dmsf"><input type="number" id="lonA_deg" placeholder="åº¦" oninput="dmsToD('lonA')"><span>(åº¦)</span></div>
                  <div class="gps-dmsf"><input type="number" id="lonA_min" placeholder="åˆ†" oninput="dmsToD('lonA')"><span>(åˆ†)</span></div>
                  <div class="gps-dmsf"><input style="min-width:60px;" type="number" id="lonA_sec" placeholder="ç§’" step="0.01" oninput="dmsToD('lonA')"><span>(ç§’)</span></div>
                  <button class="gps-cb" onclick="clearCoord('lonA')">âœ–</button> </div>
          </div>
          
          <div class="gps-er">
              <label for="eleA">é«˜åº¦ (Elevation)</label>
              <input type="number" id="eleA" placeholder="è«‹è¼¸å…¥æ•¸å€¼" step="0.01">
              <div class="control-group">
                <span>å…¬å°º (m)</span>
                <button class="gps-cb" onclick="clearElevation('A')">âœ–</button>
              </div>
          </div>
      </div>

      <div class="gps-ig orange-border-card">
          <div class="gps-loc-header">
              ğŸ¯ åœ°é» B åº§æ¨™
              <div style="display: flex; align-items: center; gap: 5px;">
                  <input type="text" id="nameB" placeholder="åœ°å B" maxlength="5">
                  <span>(åœ°å)</span>
                  <button class="gps-cb" onclick="clearNameOnly('B')">âœ–</button> 
              </div>
          </div>
          
          <div class="gps-cg">
              <span class="gps-cl">ç·¯åº¦ (Latitude) - åé€²åˆ¶/DMS</span>
              <div class="gps-ddr">
                  <input type="number" id="latB" placeholder="åé€²åˆ¶æ•¸å€¼" step="0.000001">
                  <span>(åº¦)</span>
                  <button class="gps-cb" onclick="clearCoord('latB')">âœ–</button>
              </div>
              <div class="gps-dmsr">
                  <div class="gps-dmsf"><input type="number" id="latB_deg" placeholder="åº¦" oninput="dmsToD('latB')"><span>(åº¦)</span></div>
                  <div class="gps-dmsf"><input type="number" id="latB_min" placeholder="åˆ†" oninput="dmsToD('latB')"><span>(åˆ†)</span></div>
                  <div class="gps-dmsf"><input style="min-width:60px;" type="number" id="latB_sec" placeholder="ç§’" step="0.01" oninput="dmsToD('latB')"><span>(ç§’)</span></div>
                  <button class="gps-cb" onclick="clearCoord('latB')">âœ–</button> </div>
          </div>
          
          <div class="gps-cg">
              <span class="gps-cl">ç¶“åº¦ (Longitude) - åé€²åˆ¶/DMS</span>
              <div class="gps-ddr">
                  <input type="number" id="lonB" placeholder="åé€²åˆ¶æ•¸å€¼" step="0.000001">
                  <span>(åº¦)</span>
                  <button class="gps-cb" onclick="clearCoord('lonB')">âœ–</button>
              </div>
              <div class="gps-dmsr">
                  <div class="gps-dmsf"><input type="number" id="lonB_deg" placeholder="åº¦" oninput="dmsToD('lonB')"><span>(åº¦)</span></div>
                  <div class="gps-dmsf"><input type="number" id="lonB_min" placeholder="åˆ†" oninput="dmsToD('lonB')"><span>(åˆ†)</span></div>
                  <div class="gps-dmsf"><input style="min-width:60px;" type="number" id="lonB_sec" placeholder="ç§’" step="0.01" oninput="dmsToD('lonB')"><span>(ç§’)</span></div>
                  <button class="gps-cb" onclick="clearCoord('lonB')">âœ–</button> </div>
          </div>
          
          <div class="gps-er">
              <label for="eleB">é«˜åº¦ (Elevation)</label>
              <input type="number" id="eleB" placeholder="è«‹è¼¸å…¥æ•¸å€¼" step="0.01">
              <div class="control-group">
                <span>å…¬å°º (m)</span>
                <button class="gps-cb" onclick="clearElevation('B')">âœ–</button>
              </div>
          </div>
      </div>

      <div class="btn-row" style="margin-top: 5px; margin-bottom: 5px;">
        <button id="gpsCalcBtn" class="btn" onclick="calculate()">è¨ˆç®—</button>
        <button id="gpsResetBtn" class="btn ghost" onclick="resetGps()">é è¨­</button>
        <button id="gpsClearBtn" class="btn clear" onclick="clearAllGps()">æ¸…é™¤</button>
      </div>

      <div id="gpsRes">
          é»æ“Šã€Œè¨ˆç®—ã€ä»¥é¡¯ç¤ºçµæœ
      </div>
    </div>
  </div>



  <!-- æ’å…¥ RF è¨ˆç®—å·¥å…· (from RFå·¥å…·_OK.html) -->
  
<header></header>
<main>
<div class="tab-content active" id="rftool-content">
<div class="rf-header">
<div class="section-title">ğŸš€ ç¶œåˆ RF é€šä¿¡è¨ˆç®—å·¥å…·</div>
</div>

<div class="function-selector-container">
    <label for="function_selector">é¸æ“‡é¡¯ç¤ºåŠŸèƒ½æ¨¡çµ„:</label>
    <select id="function_selector" onchange="toggleSections()">
        <option value="ALL">ALL - é¡¯ç¤ºæ‰€æœ‰è¨ˆç®—å™¨</option>
        <option value="power">1. åŠŸç‡è½‰æ› (dBm / W)</option>
        <option value="matching">2. åŒ¹é…åº¦åƒæ•¸æ›ç®—</option>
        <option value="sensitivity">3. ç³»çµ±éˆæ•åº¦ (Sensitivity) è¨ˆç®—</option>
        <option value="los">4. é€šè¦–æœ€å¤§è·é›¢è¨ˆç®—</option>
        <option value="fspl">5. è‡ªç”±ç©ºé–“æè€— (FSPL)</option>
        <option value="linkbudget">6. é€šè¨Šæ¨¡æ“¬ (Link Budget)</option>
    </select>
</div>
<section class="card section-item" id="section-power"> 
<div class="section-header-with-controls">
  <div class="section-title">1. åŠŸç‡è½‰æ› (dBm / W)</div>
  <div class="btn-group">
    <button class="btn btn-reset" onclick="resetSection('section-power')">é è¨­</button>
    <button class="btn btn-clear" onclick="clearSection('section-power')">æ¸…é™¤</button>
  </div>
</div>
<div class="input-group-border"> 
    <label for="power_unit">é¸æ“‡è¼¸å…¥å–®ä½:</label>
    <select id="power_unit" onchange="swapAndCalculate()">
        <option value="w">W</option>
        <option value="dbm">dBm</option>
    </select>
    
    <label for="power_input">è¼¸å…¥æ•¸å€¼:</label>
    <div class="input-with-clear">
        <input id="power_input" oninput="calculateDbmWNew()" placeholder="è¼¸å…¥æ•¸å€¼" type="number" value="1"/>
        <button class="clear-button" onclick="clearAndRecalculate('power_input', 'calculateDbmWNew')">Ã—</button>
    </div>
    </div> 
<div class="results-card-border" id="power_output_result">æ›ç®—çµæœ:</div>
</section>

<section class="card section-item" id="section-matching">
<div class="section-header-with-controls">
  <div class="section-title">2. åŒ¹é…åº¦åƒæ•¸æ›ç®—</div>
  <div class="btn-group">
    <button class="btn btn-reset" onclick="resetSection('section-matching')">é è¨­</button>
    <button class="btn btn-clear" onclick="clearSection('section-matching')">æ¸…é™¤</button>
  </div>
</div>
<div class="input-group-border"> <label for="matching_unit">é¸æ“‡è¼¸å…¥åƒæ•¸:</label>
  <select id="matching_unit" onchange="swapAndConvertMatching()">
  <option value="rl">å›æ³¢æè€— (Return Loss, RL) [dB]</option>
  <option value="vswr">é§æ³¢æ¯” (VSWR)</option>
  <option value="gamma">åå°„ä¿‚æ•¸ (V, Î“)</option>
  <option value="refl_pct">åå°„åŠŸç‡ [%]</option>
  <option value="pass_pct">é€šéåŠŸç‡ [%]</option>
  </select>
  <label for="matching_input_value" style="margin-top: 8px;">è¼¸å…¥æ•¸å€¼:</label>
  <div class="input-with-clear">
  <input id="matching_input_value" oninput="calculateMatching()" placeholder="ä¾‹å¦‚: 20" type="number" value="20"/>
  <button class="clear-button" onclick="clearAndRecalculate('matching_input_value', 'calculateMatching')">Ã—</button>
  </div>
</div> <div class="results-card-border" id="matching_output">
            å›æ³¢æè€— (RL) [dB]: <span class="result-value" id="rl_val"></span><br/>
            é§æ³¢æ¯” (VSWR): <span class="result-value" id="vswr_val"></span><br/>
            åå°„ä¿‚æ•¸ (Vï¼ŒÎ“): <span class="result-value" id="gamma_val"></span><br/>
            åå°„åŠŸç‡ [%]: <span class="result-value" id="refl_percent"></span><br/>
            é€šéåŠŸç‡ [%]: <span class="result-value" id="pass_percent"></span>
</div>
</section>

<section class="card section-item" id="section-sensitivity">
<div class="section-header-with-controls">
  <div class="section-title">3. ç³»çµ±éˆæ•åº¦ (Sensitivity) è¨ˆç®—</div>
  <div class="btn-group">
    <button class="btn btn-reset" onclick="resetSection('section-sensitivity')">é è¨­</button>
    <button class="btn btn-clear" onclick="clearSection('section-sensitivity')">æ¸…é™¤</button>
  </div>
</div>
<div class="input-group-border"> <label for="sensitivity_bw">è¨Šè™Ÿé »å¯¬ (BW) [MHz]:</label>
  <div class="input-with-clear">
  <input id="sensitivity_bw" oninput="calculateSensitivity()" placeholder="ä¾‹å¦‚: 1 (1MHz)" type="number" value="1"/>
  <button class="clear-button" onclick="clearAndRecalculate('sensitivity_bw', 'calculateSensitivity')">Ã—</button>
  </div>
  <label for="sensitivity_nf">é›œè¨ŠæŒ‡æ•¸ (Noise Figure, NF) [dB]:</label>
  <div class="input-with-clear">
  <input id="sensitivity_nf" oninput="calculateSensitivity()" placeholder="ä¾‹å¦‚: 5" type="number" value="5"/>
  <button class="clear-button" onclick="clearAndRecalculate('sensitivity_nf', 'calculateSensitivity')">Ã—</button>
  </div>
  <label for="sensitivity_sn">æ‰€éœ€è¨Šé›œæ¯” (S/N) [dB]:</label>
  <div class="input-with-clear">
  <input id="sensitivity_sn" oninput="calculateSensitivity()" placeholder="ä¾‹å¦‚: 10" type="number" value="10"/>
  <button class="clear-button" onclick="clearAndRecalculate('sensitivity_sn', 'calculateSensitivity')">Ã—</button>
  </div>
</div> <div class="results-card-border" id="sensitivity_output">æ¥æ”¶å™¨éˆæ•åº¦ (Sensitivity):</div>
</section>

<section class="card section-item" id="section-los"> 
<div class="section-header-with-controls">
  <div class="section-title">4. é€šè¦–æœ€å¤§è·é›¢è¨ˆç®— (åœ°çƒæ›²åº¦é®è”½)</div>
  <div class="btn-group">
    <button class="btn btn-reset" onclick="resetSection('section-los')">é è¨­</button>
    <button class="btn btn-clear" onclick="clearSection('section-los')">æ¸…é™¤</button>
  </div>
</div>
<div class="input-group-border"> 
  <div class="los-point-title">A é»</div>
  <div class="los-input-container">
    <div class="input-item">
      <label for="los_g1">å¤©ç·šæ¶è¨­é»æ°´å¹³é¢é«˜åº¦ [m]:</label>
      <div class="input-with-clear">
        <input id="los_g1" oninput="calculateMaxLOS()" placeholder="ä¾‹å¦‚: 100" type="number" value="0"/>
        <button class="clear-button" onclick="clearAndRecalculate('los_g1', 'calculateMaxLOS')">Ã—</button>
      </div>
    </div>
    <div class="input-item">
      <label for="los_h1">å¤©ç·šé«˜åº¦ [m]:</label>
      <div class="input-with-clear">
        <input id="los_h1" oninput="calculateMaxLOS()" placeholder="ä¾‹å¦‚: 10" type="number" value="10"/>
        <button class="clear-button" onclick="clearAndRecalculate('los_h1', 'calculateMaxLOS')">Ã—</button>
      </div>
    </div>
  </div>
  <div class="los-point-title">B é»</div>
  <div class="los-input-container">
    <div class="input-item">
      <label for="los_g2">å¤©ç·šæ¶è¨­é»æ°´å¹³é¢é«˜åº¦ [m]:</label>
      <div class="input-with-clear">
        <input id="los_g2" oninput="calculateMaxLOS()" placeholder="ä¾‹å¦‚: 150" type="number" value="0"/>
        <button class="clear-button" onclick="clearAndRecalculate('los_g2', 'calculateMaxLOS')">Ã—</button>
      </div>
    </div>
    <div class="input-item">
      <label for="los_h2">å¤©ç·šé«˜åº¦ [m]:</label>
      <div class="input-with-clear">
        <input id="los_h2" oninput="calculateMaxLOS()" placeholder="ä¾‹å¦‚: 20" type="number" value="20"/>
        <button class="clear-button" onclick="clearAndRecalculate('los_h2', 'calculateMaxLOS')">Ã—</button>
      </div>
    </div>
  </div>
</div> <div class="results-card-border" id="los_output">æœ€å¤§é€šè¦–è·é›¢:</div>
</section>

<section class="card section-item" id="section-fspl">
<div class="section-header-with-controls">
  <div class="section-title">5. è‡ªç”±ç©ºé–“æè€— (Free Space Path Loss, FSPL)</div>
  <div class="btn-group">
    <button class="btn btn-reset" onclick="resetSection('section-fspl')">é è¨­</button>
    <button class="btn btn-clear" onclick="clearSection('section-fspl')">æ¸…é™¤</button>
  </div>
</div>
<div class="input-group-border"> 
    <label for="fspl_freq">é »ç‡ (Frequency) [MHz]:</label>
    <div class="input-with-clear">
    <input id="fspl_freq" oninput="calculateFSPL()" placeholder="ä¾‹å¦‚: 2400 (2.4 GHz)" type="number" value="2400"/>
    <button class="clear-button" onclick="clearAndRecalculate('fspl_freq', 'calculateFSPL')">Ã—</button>
    </div>
    <label for="fspl_dist">è·é›¢ (Distance) [km]:</label>
    <div class="input-with-clear">
    <input id="fspl_dist" oninput="calculateFSPL()" placeholder="ä¾‹å¦‚: 10" type="number" value="10"/>
    <button class="clear-button" onclick="clearAndRecalculate('fspl_dist', 'calculateFSPL')">Ã—</button>
    </div>
</div>
<div class="results-card-border" id="fspl_output">è‡ªç”±ç©ºé–“è¡°æ¸›é‡ (FSPL):</div>
</section>

<section class="card section-item" id="section-linkbudget">
<div class="section-header-with-controls">
  <div class="section-title">6. é€šè¨Šæ¨¡æ“¬ (Link Budget)</div>
  <div class="btn-group">
    <button class="btn btn-reset" onclick="resetSection('section-linkbudget')">é è¨­</button>
    <button class="btn btn-clear" onclick="clearSection('section-linkbudget')">æ¸…é™¤</button>
  </div>
</div>
<div class="input-group-border">
  <div class="los-point-title" style="margin-top: 0;">é€šä¿¡åƒæ•¸</div>
  <div class="los-input-container">
    <div class="input-item">
      <label for="link_freq_mhz">é »ç‡ (Frequency) [MHz]:</label>
      <div class="input-with-clear">
        <input id="link_freq_mhz" oninput="calculateLinkBudget()" placeholder="ä¾‹å¦‚: 2400 (2.4 GHz)" type="number" value="2400"/>
        <button class="clear-button" onclick="clearAndRecalculate('link_freq_mhz', 'calculateLinkBudget')">Ã—</button>
      </div>
    </div>
    <div class="input-item">
      <label for="link_dist_km">è·é›¢ (Distance) [km]:</label>
      <div class="input-with-clear">
        <input id="link_dist_km" oninput="calculateLinkBudget()" placeholder="ä¾‹å¦‚: 10" type="number" value="10"/>
        <button class="clear-button" onclick="clearAndRecalculate('link_dist_km', 'calculateLinkBudget')">Ã—</button>
      </div>
    </div>
  </div>

  <div class="los-point-title">ç™¼å°„ç«¯ (Tx)</div>
  <label for="link_tx_power_unit">ç™¼å°„åŠŸç‡è¼¸å…¥å–®ä½:</label>
  <select id="link_tx_power_unit" onchange="calculateLinkBudget()">
      <option value="w">W</option>
      <option value="dbm">dBm</option>
  </select>
  <div class="los-input-container">
    <div class="input-item">
      <label for="link_tx_power_input">ç™¼å°„åŠŸç‡ (Tx Power) [W/dBm]:</label>
      <div class="input-with-clear">
        <input id="link_tx_power_input" oninput="calculateLinkBudget()" placeholder="ä¾‹å¦‚: 1 (1W)" type="number" value="1"/>
        <button class="clear-button" onclick="clearAndRecalculate('link_tx_power_input', 'calculateLinkBudget')">Ã—</button>
      </div>
    </div>
    <div class="input-item">
      <label for="link_tx_gain_dbi">å¤©ç·šå¢ç›Š (Tx Gain) [dBi]:</label>
      <div class="input-with-clear">
        <input id="link_tx_gain_dbi" oninput="calculateLinkBudget()" placeholder="ä¾‹å¦‚: 20" type="number" value="20"/>
        <button class="clear-button" onclick="clearAndRecalculate('link_tx_gain_dbi', 'calculateLinkBudget')">Ã—</button>
      </div>
    </div>
    <div class="input-item">
      <label for="link_tx_loss_db">ç·šæ (Tx Loss) [dB]:</label>
      <div class="input-with-clear">
        <input id="link_tx_loss_db" oninput="calculateLinkBudget()" placeholder="ä¾‹å¦‚: 3 (3 dB)" type="number" value="3"/>
        <button class="clear-button" onclick="clearAndRecalculate('link_tx_loss_db', 'calculateLinkBudget')">Ã—</button>
      </div>
    </div>
  </div>

  <div class="los-point-title">æ¥æ”¶ç«¯ (Rx)</div>
  <div class="los-input-container">
    <div class="input-item">
      <label for="link_rx_gain_dbi">å¤©ç·šå¢ç›Š (Rx Gain) [dBi]:</label>
      <div class="input-with-clear">
        <input id="link_rx_gain_dbi" oninput="calculateLinkBudget()" placeholder="ä¾‹å¦‚: 20" type="number" value="20"/>
        <button class="clear-button" onclick="clearAndRecalculate('link_rx_gain_dbi', 'calculateLinkBudget')">Ã—</button>
      </div>
    </div>
    <div class="input-item">
      <label for="link_rx_loss_db">ç·šæ (Rx Loss) [dB]:</label>
      <div class="input-with-clear">
        <input id="link_rx_loss_db" oninput="calculateLinkBudget()" placeholder="ä¾‹å¦‚: 2 (2 dB)" type="number" value="2"/>
        <button class="clear-button" onclick="clearAndRecalculate('link_rx_loss_db', 'calculateLinkBudget')">Ã—</button>
      </div>
    </div>
  </div>
</div>
<div class="results-card-border" id="linkbudget_output">æ¥æ”¶è¨Šè™Ÿå¼·åº¦:</div>
</section>
</div>
</main>
<script>
// æ‰€æœ‰è¨ˆç®—æ¨¡çµ„çš„ ID æ˜ å°„
const sectionIds = {
    'power': 'section-power',
    'matching': 'section-matching',
    'sensitivity': 'section-sensitivity',
    'los': 'section-los',
    'fspl': 'section-fspl',
    'linkbudget': 'section-linkbudget'
};

// --- æ–°å¢é è¨­/æ¸…é™¤åŠŸèƒ½ ---

// 1. é è¨­å€¼èˆ‡è¨ˆç®—å‡½æ•¸æ˜ å°„
const defaultValues = {
    // 1. åŠŸç‡è½‰æ› (dBm / W)
    'section-power': {
        'power_input': '1',
        'power_unit': 'w',
    },
    // 2. åŒ¹é…åº¦åƒæ•¸æ›ç®—
    'section-matching': {
        'matching_input_value': '20',
        'matching_unit': 'rl',
    },
    // 3. ç³»çµ±éˆæ•åº¦ (Sensitivity) è¨ˆç®—
    'section-sensitivity': {
        'sensitivity_bw': '1',
        'sensitivity_nf': '5',
        'sensitivity_sn': '10',
    },
    // 4. é€šè¦–æœ€å¤§è·é›¢è¨ˆç®—
    'section-los': {
        'los_g1': '0',
        'los_h1': '10',
        'los_g2': '0',
        'los_h2': '20',
    },
    // 5. è‡ªç”±ç©ºé–“æè€— (FSPL)
    'section-fspl': {
        'fspl_freq': '2400',
        'fspl_dist': '10',
    },
    // 6. é€šè¨Šæ¨¡æ“¬ (Link Budget)
    'section-linkbudget': {
        'link_tx_power_input': '1',
        'link_tx_power_unit': 'w',
        'link_tx_loss_db': '3',
        'link_tx_gain_dbi': '20',
        'link_dist_km': '10',
        'link_freq_mhz': '2400',
        'link_rx_gain_dbi': '20',
        'link_rx_loss_db': '2',
    }
};

const calculationFunctions = {
    'section-power': 'calculateDbmWNew',
    'section-matching': 'calculateMatching',
    'section-sensitivity': 'calculateSensitivity',
    'section-los': 'calculateMaxLOS',
    'section-fspl': 'calculateFSPL',
    'section-linkbudget': 'calculateLinkBudget',
};

/**
 * å–å¾—æŒ‡å®šå€å¡Šä¸­æ‰€æœ‰éœ€è¦æ§åˆ¶çš„è¼¸å…¥æ¬„ä½ (input, select)
 * @param {string} sectionId å€å¡Š ID
 * @returns {HTMLElement[]} å…ƒç´ é™£åˆ—
 */
function getSectionControls(sectionId) {
    const sectionEl = document.getElementById(sectionId);
    if (!sectionEl) return [];
    
    // é™åˆ¶åœ¨ .input-group-border å…§ï¼Œæ’é™¤ä¸»åŠŸèƒ½é¸æ“‡å™¨
    const inputGroup = sectionEl.querySelector('.input-group-border');
    if (!inputGroup) return [];

    // å–å¾—æ‰€æœ‰å…·æœ‰ ID çš„ input å’Œ select å…ƒç´ 
    return Array.from(inputGroup.querySelectorAll('input, select')).filter(el => el.id);
}

/**
 * å°‡æŒ‡å®šå€å¡Šæ‰€æœ‰æ•¸å€¼å›å¾©æˆé è¨­å€¼ (Reset)
 * @param {string} sectionId å€å¡Š ID
 */
function resetSection(sectionId) {
    const defaults = defaultValues[sectionId];
    if (defaults) {
        // è¿­ä»£é è¨­å€¼åˆ—è¡¨ï¼Œè¨­å®šå…ƒç´ å€¼
        for (const id in defaults) {
            const element = document.getElementById(id);
            if (element) {
                element.value = defaults[id];
                // ç¢ºä¿æ•¸å€¼è¼¸å…¥æ¬„ä½å¯ä»¥æ¥å—ç©ºå­—ä¸² (Clear)
                if(element.tagName === 'INPUT') element.value = defaults[id];
            }
        }
    }
    // åŸ·è¡Œè¨ˆç®—
    const calcFunc = calculationFunctions[sectionId];
    if (calcFunc && typeof window[calcFunc] === 'function') {
        window[calcFunc]();
    }
}

/**
 * æ¸…é™¤æŒ‡å®šå€å¡Šæ‰€æœ‰æ•¸å€¼ (Clear)
 * - è¼¸å…¥æ¬„ä½è¨­å®šç‚ºç©ºå­—ä¸² ''
 * - å–®ä½é¸æ“‡å™¨è¨­å®šå›é è¨­ functional default (èˆ‡ reset ç›¸åŒçš„å€¼)
 * @param {string} sectionId å€å¡Š ID
 */
function clearSection(sectionId) {
    const controls = getSectionControls(sectionId);
    const defaults = defaultValues[sectionId] || {}; // ç”¨æ–¼å–å¾— Select çš„é è¨­å€¼

    controls.forEach(element => {
        const id = element.id;
        if (element.tagName === 'INPUT') {
            element.value = ''; // æ¸…é™¤è¼¸å…¥æ¡†æ•¸å€¼
        } else if (element.tagName === 'SELECT') {
            // å–®ä½é¸æ“‡å™¨ (Select) æ‡‰è¨­å®šå›é è¨­åŠŸèƒ½å€¼ (é¿å…ç„¡æ•ˆé¸é …å°è‡´éŒ¯èª¤)
            if (defaults[id]) {
                element.value = defaults[id];
            } else {
                element.selectedIndex = 0; 
            }
        }
    });
    
    // åŸ·è¡Œè¨ˆç®—
    const calcFunc = calculationFunctions[sectionId];
    if (calcFunc && typeof window[calcFunc] === 'function') {
        window[calcFunc]();
    }
}
// --- çµæŸæ–°å¢ ---

// --- åŠŸèƒ½åˆ‡æ›å‡½æ•¸ --- 
function toggleSections() { 
    const selector = document.getElementById('function_selector'); 
    const selectedValue = selector.value; 
    const allSections = document.querySelectorAll('.section-item'); 
    allSections.forEach(section => { 
        const sectionKey = Object.keys(sectionIds).find(key => sectionIds[key] === section.id); 
        if (selectedValue === 'ALL') { 
            section.style.display = 'block'; 
        } else if (sectionKey === selectedValue) { 
            section.style.display = 'block'; 
        } else { 
            section.style.display = 'none'; 
        } 
    }); 
    // ç¢ºä¿åœ¨åˆ‡æ›æ™‚ï¼Œç•«é¢æœƒé‡æ–°è¨ˆç®—ä¸¦é¡¯ç¤ºçµæœ (å¦‚æœæ¨¡çµ„è¢«é¡¯ç¤º) 
    if (selectedValue === 'ALL' || selectedValue === 'power') calculateDbmWNew(); 
    if (selectedValue === 'ALL' || selectedValue === 'matching') calculateMatching(); 
    if (selectedValue === 'ALL' || selectedValue === 'sensitivity') calculateSensitivity(); 
    if (selectedValue === 'ALL' || selectedValue === 'los') calculateMaxLOS();
    if (selectedValue === 'ALL' || selectedValue === 'fspl') calculateFSPL();
    if (selectedValue === 'ALL' || selectedValue === 'linkbudget') calculateLinkBudget();
}

/**
 * å€‹åˆ¥è¼¸å…¥æ¬„ä½æ¸…é™¤ä¸¦é‡æ–°è¨ˆç®—
 * @param {string} inputId è¼¸å…¥æ¬„ä½ ID
 * @param {string} calcFunc è¨ˆç®—å‡½æ•¸åç¨±
 */
function clearAndRecalculate(inputId, calcFunc) {
    const inputElement = document.getElementById(inputId);
    if (inputElement) {
        inputElement.value = '';
    }
    if (typeof window[calcFunc] === 'function') {
        window[calcFunc]();
    }
}

// --- 1. åŠŸç‡è½‰æ› (dBm / W) ---
// è¼”åŠ©å‡½æ•¸ï¼šåŸ·è¡Œ dBm <-> W è½‰æ›
function convertPower(value, fromUnit, toUnit) {
    if (fromUnit === toUnit) return value;
    if (fromUnit === 'w' && toUnit === 'dbm') {
        // W to dBm: 10 * log10(P_W / 1mW) = 10 * log10(P_W * 1000)
        return 10 * Math.log10(value * 1000);
    } else if (fromUnit === 'dbm' && toUnit === 'w') {
        // dBm to W: 10^(P_dBm / 10) * 1mW = 10^(P_dBm / 10 - 3)
        return Math.pow(10, (value / 10) - 3);
    }
    return NaN;
}

// ç”¨æ–¼è¨˜éŒ„ä¸Šä¸€æ¬¡è¼¸å…¥çš„å–®ä½ï¼Œä»¥åœ¨åˆ‡æ›å–®ä½æ™‚é€²è¡Œæ•¸å€¼æ›ç®—
let power_conv_last_unit = 'w'; 

function calculateDbmWNew() {
    const input = document.getElementById('power_input');
    const unit = document.getElementById('power_unit').value;
    const output = document.getElementById('power_output_result');
    const redColor = getComputedStyle(document.documentElement).getPropertyValue('--red-clear');
    const unit_color = getComputedStyle(document.body).color; // ä¸»è¦æ–‡å­—é¡è‰² (ç™½è‰²)

    const input_value = parseFloat(input.value);

    if (isNaN(input_value) || input.value.trim() === '') {
        output.innerHTML = `æ›ç®—çµæœ: <span style="color:${redColor};">è«‹è¼¸å…¥æ•¸å€¼</span>`;
        return;
    }
    
    // æª¢æŸ¥æ•¸å€¼ç¯„åœ
    if (unit === 'w' && input_value < 0) {
        output.innerHTML = `æ›ç®—çµæœ: <span style="color:${redColor};">åŠŸç‡ (W) å¿…é ˆ â‰¥ 0</span>`;
        return;
    }

    let result_value, result_unit;

    if (unit === 'w') {
        result_value = convertPower(input_value, 'w', 'dbm');
        result_unit = 'dBm';
        // é¡å¤–æª¢æŸ¥ dBm è½‰æ›æ˜¯å¦æœ‰æ•ˆ (åªæœ‰ 0 W æœƒæ˜¯ -Infinity)
        if (result_value === -Infinity) {
            output.innerHTML = `æ›ç®—çµæœ: <span class="result-value">-âˆ</span> <span style="color:${unit_color};">${result_unit}</span>`;
            return;
        }
    } else { // unit === 'dbm'
        result_value = convertPower(input_value, 'dbm', 'w');
        result_unit = 'W';
        // æª¢æŸ¥ W è½‰æ›æ˜¯å¦æœ‰æ•ˆ (æ¥µå°çš„æ•¸å€¼)
        if (result_value < 0) result_value = 0;
    }
    
    if (isNaN(result_value)) {
        output.innerHTML = `æ›ç®—çµæœ: <span style="color:${redColor};">è¼¸å…¥ç„¡æ•ˆ</span>`;
        return;
    } else {
        // è¼¸å‡ºæ•¸å€¼ï¼Œå–®ä½å¥—ç”¨ç™½è‰²
        output.innerHTML = `æ›ç®—çµæœ: <span class="result-value">${result_value.toFixed(3)}</span> <span style="color:${unit_color};">${result_unit}</span>`;
    }
    power_conv_last_unit = unit;
}

function swapAndCalculate() {
    const input = document.getElementById('power_input');
    const current_unit = document.getElementById('power_unit').value;
    const input_value = parseFloat(input.value);

    if (!isNaN(input_value) && input.value.trim() !== '') {
        const new_value = convertPower(input_value, power_conv_last_unit, current_unit);
        if (!isNaN(new_value)) {
            // è™•ç† 0 W è½‰æ›ç‚º -Infinity dBm çš„æƒ…æ³
            if (current_unit === 'dbm' && new_value === -Infinity) {
                // å¦‚æœå–®ä½åˆ‡æ›åˆ° dBm ä¸”åŸå€¼ç‚º 0 Wï¼Œä¸æ”¹è®Š input.valueï¼Œè®“ calculateDbmWNew è™•ç†è¼¸å‡º
            } else {
                input.value = new_value.toFixed(3);
            }
        } else {
             // è™•ç†è¼¸å…¥ç„¡æ•ˆå°è‡´çš„ NaNï¼Œä½†å¦‚æœåŸå€¼æ˜¯æœ‰æ•ˆçš„ï¼Œé€™è£¡ä¸æ‡‰æ¸…é™¤
        }
    }
    calculateDbmWNew();
}


// --- 2. åŒ¹é…åº¦è½‰æ› (å‹•æ…‹æ›ç®—é‚è¼¯) ---
let last_matching_unit = 'rl'; 

function getGammaFromValue(value, type) {
    if (type === 'rl') {
        if (value < 0) throw new Error("RL å¿…é ˆ â‰¥ 0 dB");
        return Math.pow(10, -value / 20);
    } else if (type === 'vswr') {
        if (value < 1) throw new Error("VSWR å¿…é ˆ â‰¥ 1");
        return (value - 1) / (value + 1);
    } else if (type === 'gamma') {
        if (value < 0 || value > 1) throw new Error("Î“ å¿…é ˆä»‹æ–¼ 0 åˆ° 1 ä¹‹é–“");
        return value;
    } else if (type === 'refl_pct') {
        if (value < 0 || value > 100) throw new Error("åå°„åŠŸç‡å¿…é ˆä»‹æ–¼ 0 åˆ° 100 ä¹‹é–“");
        return Math.sqrt(value / 100);
    } else if (type === 'pass_pct') {
        if (value < 0 || value > 100) throw new Error("é€šéåŠŸç‡å¿…é ˆä»‹æ–¼ 0 åˆ° 100 ä¹‹é–“");
        return Math.sqrt(1 - (value / 100));
    }
    return NaN;
}

function getValueFromGamma(gamma, type) {
    if (isNaN(gamma) || gamma === Infinity) return NaN;

    if (type === 'rl') {
        // -20 * log10(|Î“|)
        if (gamma === 0) return Infinity;
        // ç¢ºä¿è¼¸å…¥æ˜¯æ­£æ•¸ä»¥é¿å… Math.log10 éŒ¯èª¤
        return -20 * Math.log10(Math.abs(gamma));
    } else if (type === 'vswr') {
        // (1 + |Î“|) / (1 - |Î“|)
        if (gamma === 1) return Infinity;
        return (1 + Math.abs(gamma)) / (1 - Math.abs(gamma));
    } else if (type === 'gamma') {
        return Math.abs(gamma);
    } else if (type === 'refl_pct') {
        // |Î“|^2 * 100%
        return Math.abs(gamma)**2 * 100;
    } else if (type === 'pass_pct') {
        // (1 - |Î“|^2) * 100%
        return (1 - Math.abs(gamma)**2) * 100;
    }
    return NaN;
}

function swapAndConvertMatching() {
    const current_unit = document.getElementById('matching_unit').value;
    const input_element = document.getElementById('matching_input_value');
    const input_value = parseFloat(input_element.value);

    // åªæœ‰åœ¨è¼¸å…¥æ•¸å€¼æœ‰æ•ˆæ™‚æ‰å˜—è©¦æ›ç®—
    if (!isNaN(input_value) && input_element.value.trim() !== '') {
        let gamma_abs;
        try {
            // 1. å¾èˆŠå–®ä½æ›ç®—åˆ°çµ•å°å€¼åå°„ä¿‚æ•¸ |Î“|
            gamma_abs = getGammaFromValue(input_value, last_matching_unit);
            if (!isNaN(gamma_abs)) {
                // 2. å°‡ |Î“| æ›ç®—æˆæ–°å–®ä½çš„å€¼
                const new_value = getValueFromGamma(gamma_abs, current_unit);
                if (!isNaN(new_value) && new_value !== Infinity) {
                    // å¦‚æœæ–°å–®ä½æ˜¯ RLï¼Œä¿ç•™ 2 ä½å°æ•¸ï¼Œå…¶ä»–ä¿ç•™ 4 ä½å°æ•¸
                    const precision = (current_unit === 'rl' || current_unit === 'refl_pct' || current_unit === 'pass_pct') ? 2 : 4;
                    input_element.value = new_value.toFixed(precision);
                } else if (new_value === Infinity) {
                    input_element.value = '1'; // VSWR/RL ç„¡çª®å¤§æ™‚ï¼Œåå°„ä¿‚æ•¸ç‚º 1
                } else {
                    input_element.value = '';
                }
            } else {
                input_element.value = '';
            }
        } catch (error) {
             input_element.value = '';
        }
    }
    calculateMatching();
    last_matching_unit = current_unit;
}

function calculateMatching() {
    const input_type = document.getElementById('matching_unit').value;
    const input_element = document.getElementById('matching_input_value');
    const input_value = parseFloat(input_element.value);
    
    const redColor = getComputedStyle(document.documentElement).getPropertyValue('--red-clear');
    const unit_color = getComputedStyle(document.body).color;

    const output_elements = {
        rl: document.getElementById('rl_val'),
        vswr: document.getElementById('vswr_val'),
        gamma: document.getElementById('gamma_val'),
        refl_pct: document.getElementById('refl_percent'),
        pass_pct: document.getElementById('pass_percent')
    };

    const empty_output = `<span style="color:${redColor};font-size:17px;">è«‹è¼¸å…¥æ•¸å€¼</span>`;

    // æ¸…ç©ºæ‰€æœ‰è¼¸å‡º
    Object.values(output_elements).forEach(el => el.innerHTML = '');

    if (isNaN(input_value) || input_element.value.trim() === '') {
        output_elements.rl.innerHTML = empty_output;
        return;
    }

    let gamma_abs;
    try {
        gamma_abs = getGammaFromValue(input_value, input_type);
    } catch (error) {
        output_elements.rl.innerHTML = `<span style="color:${redColor};font-size:17px;">${error.message}</span>`;
        return;
    }
    
    // è¼¸å‡ºæ›ç®—çµæœ
    const rl_val = getValueFromGamma(gamma_abs, 'rl');
    const vswr_val = getValueFromGamma(gamma_abs, 'vswr');
    const gamma_val = getValueFromGamma(gamma_abs, 'gamma');
    const refl_pct = getValueFromGamma(gamma_abs, 'refl_pct');
    const pass_pct = getValueFromGamma(gamma_abs, 'pass_pct');

    const formatOutput = (value, unit, precision=2) => {
        if (value === Infinity) return `<span class="result-value">âˆ</span> <span style="color:${unit_color};">${unit}</span>`;
        if (isNaN(value)) return `<span style="color:${redColor};font-size:17px;">è¨ˆç®—éŒ¯èª¤</span>`;
        return `<span class="result-value">${value.toFixed(precision)}</span> <span style="color:${unit_color};">${unit}</span>`;
    }

    output_elements.rl.innerHTML = formatOutput(rl_val, 'dB');
    output_elements.vswr.innerText = vswr_val === Infinity ? 'âˆ' : vswr_val.toFixed(3);
    output_elements.gamma.innerText = gamma_val.toFixed(4);
    output_elements.refl_pct.innerHTML = formatOutput(refl_pct, '%');
    output_elements.pass_pct.innerHTML = formatOutput(pass_pct, '%');

    last_matching_unit = input_type;
}

// --- 3. é€šä¿¡ç³»çµ±éˆæ•åº¦è¨ˆç®— ---
// è¼”åŠ©å¸¸æ•¸
const BOLTZMANN_K_J = 1.380649e-23; // J/K
const T_KELVIN = 290; // åƒè€ƒæº«åº¦ (290 K)
// é›œè¨Šåœ°æ¿ (Noise Floor) P_n (dBm) = -174 + 10 * log10(BW_Hz) + NF_dB
// P_n (dBm) = -174 + 10 * log10(BW_MHz * 10^6) + NF_dB
// P_n (dBm) = -174 + 10 * (log10(BW_MHz) + 6) + NF_dB
// P_n (dBm) = -174 + 10*log10(BW_MHz) + 60 + NF_dB
// P_n (dBm) = -114 + 10*log10(BW_MHz) + NF_dB

function calculateSensitivity() {
    const bw_mhz = parseFloat(document.getElementById('sensitivity_bw').value);
    const nf_db = parseFloat(document.getElementById('sensitivity_nf').value);
    const sn_db = parseFloat(document.getElementById('sensitivity_sn').value);
    const output = document.getElementById('sensitivity_output');
    const redColor = getComputedStyle(document.documentElement).getPropertyValue('--red-clear');
    const unit_color = getComputedStyle(document.body).color;

    if (isNaN(bw_mhz) || isNaN(nf_db) || isNaN(sn_db) || bw_mhz <= 0 || nf_db < 0) {
        output.innerHTML = `æ¥æ”¶å™¨éˆæ•åº¦ (Sensitivity): <span style="color:${redColor};">è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼ (BW > 0, NF â‰¥ 0)</span>`;
        return;
    }

    // 1. è¨ˆç®—ç†±é›œè¨Šåœ°æ¿ (Noise Floor) P_n (dBm)
    // P_n (dBm) = -174 + 10 * log10(BW_Hz) + NF_dB
    // ç°¡åŒ–ç‚ºï¼š -114 + 10*log10(BW_MHz) + NF_dB
    const noise_floor_dbm = -114 + (10 * Math.log10(bw_mhz)) + nf_db;

    // 2. è¨ˆç®—éˆæ•åº¦ (Sensitivity)
    // Sensitivity (dBm) = P_n (dBm) + S/N (dB)
    const sensitivity_dbm = noise_floor_dbm + sn_db;

    output.innerHTML = `
        æ¥æ”¶å™¨éˆæ•åº¦ (Sensitivity): <span class="result-value">${sensitivity_dbm.toFixed(2)}</span> <span style="color:${unit_color};">dBm</span><br>
        <span class="result-value-small">ç†±é›œè¨Šåœ°æ¿ (Noise Floor) Pn: ${noise_floor_dbm.toFixed(2)} dBm</span>
    `;
}

// --- 4. é€šè¦–æœ€å¤§è·é›¢è¨ˆç®— (åœ°çƒæ›²åº¦é®è”½) ---
// è¼”åŠ©å¸¸æ•¸
const K_FACTOR = 4 / 3; // K=4/3 (ç­‰æ•ˆåœ°çƒåŠå¾‘å¸¸æ•¸)
const R_EARTH_KM = 6371; // åœ°çƒåŠå¾‘ (km)

function calculateMaxLOS() {
    // è®€å–è¼¸å…¥å€¼ (å¤©ç·šé«˜åº¦ H + åœ°å¹³é¢é«˜åº¦ G = çµ•å°é«˜åº¦ A)
    const g1 = parseFloat(document.getElementById('los_g1').value) || 0;
    const h1 = parseFloat(document.getElementById('los_h1').value) || 0;
    const g2 = parseFloat(document.getElementById('los_g2').value) || 0;
    const h2 = parseFloat(document.getElementById('los_h2').value) || 0;

    const output = document.getElementById('los_output');
    const redColor = getComputedStyle(document.documentElement).getPropertyValue('--red-clear');
    const unit_color = getComputedStyle(document.body).color;

    // æª¢æŸ¥é«˜åº¦æ˜¯å¦æœ‰æ•ˆ
    if (h1 < 0 || h2 < 0) {
        output.innerHTML = `æœ€å¤§é€šè¦–è·é›¢: <span style="color:${redColor};">å¤©ç·šé«˜åº¦å¿…é ˆ â‰¥ 0</span>`;
        return;
    }
    
    // çµ•å°é«˜åº¦ (m)
    const a1 = g1 + h1;
    const a2 = g2 + h2;
    
    // æª¢æŸ¥çµ•å°é«˜åº¦æ˜¯å¦æœ‰æ•ˆ
    if (a1 <= 0 || a2 <= 0) {
        output.innerHTML = `æœ€å¤§é€šè¦–è·é›¢: <span style="color:${redColor};">è«‹è¼¸å…¥æœ‰æ•ˆçš„ (å¤©ç·šçµ•å°é«˜åº¦ > 0) æ•¸å€¼</span>`;
        return;
    }

    // ç­‰æ•ˆåœ°çƒåŠå¾‘ (km)
    const R_eff = K_FACTOR * R_EARTH_KM; 
    
    // æœ€å¤§é€šè¦–è·é›¢å…¬å¼ (Distance D_km) = sqrt(2 * R_eff * A_1 / 1000) + sqrt(2 * R_eff * A_2 / 1000)
    // é€™è£¡ A_1, A_2 æ˜¯çµ•å°é«˜åº¦ (m)ï¼Œæ‰€ä»¥é™¤ä»¥ 1000 è½‰æ›ç‚º km
    const d1_km = Math.sqrt(2 * R_eff * a1 / 1000);
    const d2_km = Math.sqrt(2 * R_eff * a2 / 1000);

    const max_los_km = d1_km + d2_km;

    output.innerHTML = `
        æœ€å¤§é€šè¦–è·é›¢: <span class="result-value">${max_los_km.toFixed(2)}</span> <span style="color:${unit_color};">km</span><br>
        <span class="result-value-small">Aé»è¦–è·: ${d1_km.toFixed(2)} km; Bé»è¦–è·: ${d2_km.toFixed(2)} km</span>
    `;
}

// --- 5. è‡ªç”±ç©ºé–“æè€— (Free Space Path Loss, FSPL) ---
// FSPL (dB) = 20 log10(d) + 20 log10(f) + 20 log10(4Ï€/c)
// FSPL (dB) = 32.44 + 20 * log10(f_MHz) + 20 * log10(d_km)
function calculateFSPL() {
    const freq_mhz = parseFloat(document.getElementById('fspl_freq').value);
    const dist_km = parseFloat(document.getElementById('fspl_dist').value);
    const output = document.getElementById('fspl_output');
    const redColor = getComputedStyle(document.documentElement).getPropertyValue('--red-clear');
    const unit_color = getComputedStyle(document.body).color;

    if (isNaN(freq_mhz) || isNaN(dist_km) || freq_mhz <= 0 || dist_km <= 0) {
        output.innerHTML = `è‡ªç”±ç©ºé–“è¡°æ¸›é‡ (FSPL): <span style="color:${redColor};">è«‹è¼¸å…¥æœ‰æ•ˆçš„ (é »ç‡ > 0, è·é›¢ > 0) æ•¸å€¼</span>`;
        return;
    }

    // FSPL (dB) = 32.44 + 20 * log10(f_MHz) + 20 * log10(d_km)
    const fspl_db = 32.44 + (20 * Math.log10(freq_mhz)) + (20 * Math.log10(dist_km));
    
    output.innerHTML = `è‡ªç”±ç©ºé–“è¡°æ¸›é‡ (FSPL): <span class="result-value">${fspl_db.toFixed(2)}</span> <span style="color:${unit_color};">dB</span>`;
}

// --- 6. é€šè¨Šæ¨¡æ“¬ (Link Budget) ---
function calculateLinkBudget() {
    // é€šä¿¡åƒæ•¸
    const freq_mhz = parseFloat(document.getElementById('link_freq_mhz').value);
    const dist_km = parseFloat(document.getElementById('link_dist_km').value);

    // Tx ç«¯åƒæ•¸
    const tx_power_input = parseFloat(document.getElementById('link_tx_power_input').value);
    const tx_power_unit = document.getElementById('link_tx_power_unit').value;
    const tx_loss_db = parseFloat(document.getElementById('link_tx_loss_db').value) || 0;
    const tx_gain_dbi = parseFloat(document.getElementById('link_tx_gain_dbi').value) || 0;
    
    // Rx ç«¯åƒæ•¸
    const rx_gain_dbi = parseFloat(document.getElementById('link_rx_gain_dbi').value) || 0;
    const rx_loss_db = parseFloat(document.getElementById('link_rx_loss_db').value) || 0;
    
    const output = document.getElementById('linkbudget_output');
    const redColor = getComputedStyle(document.documentElement).getPropertyValue('--red-clear');
    const unit_color = getComputedStyle(document.body).color;

    // æª¢æŸ¥åŸºæœ¬è¼¸å…¥æœ‰æ•ˆæ€§
    if (isNaN(freq_mhz) || isNaN(dist_km) || freq_mhz <= 0 || dist_km <= 0) {
        output.innerHTML = `æ¥æ”¶è¨Šè™Ÿå¼·åº¦: <span style="color:${redColor};">è«‹è¼¸å…¥æœ‰æ•ˆçš„ (é »ç‡ > 0, è·é›¢ > 0) æ•¸å€¼</span>`;
        return;
    }
    
    if (isNaN(tx_power_input) || (tx_power_unit === 'w' && tx_power_input < 0)) {
         output.innerHTML = `æ¥æ”¶è¨Šè™Ÿå¼·åº¦: <span style="color:${redColor};">è«‹è¼¸å…¥æœ‰æ•ˆçš„ç™¼å°„åŠŸç‡</span>`;
         return;
    }

    // 1. è½‰æ›ç™¼å°„åŠŸç‡ç‚º dBm
    const tx_power_dbm = convertPower(tx_power_input, tx_power_unit, 'dbm');

    if (isNaN(tx_power_dbm)) {
         output.innerHTML = `æ¥æ”¶è¨Šè™Ÿå¼·åº¦: <span style="color:${redColor};">ç™¼å°„åŠŸç‡ (W) å¿…é ˆ > 0</span>`;
         return;
    }

    // 2. è¨ˆç®— FSPL (è‡ªç”±ç©ºé–“æè€—)
    // FSPL (dB) = 32.44 + 20 * log10(f_MHz) + 20 * log10(d_km)
    const fspl_db = 32.44 + (20 * Math.log10(freq_mhz)) + (20 * Math.log10(dist_km));
    
    // 3. è¨ˆç®— Link Budget (æ¥æ”¶åŠŸç‡)
    // P_R (dBm) = P_T(dBm) - L_Tx + G_Tx - FSPL + G_Rx - L_Rx
    const rx_power_dbm = tx_power_dbm - tx_loss_db + tx_gain_dbi - fspl_db + rx_gain_dbi - rx_loss_db;
    
    // è¼¸å‡ºæ•¸å€¼
    output.innerHTML = `
        æ¥æ”¶è¨Šè™Ÿå¼·åº¦: <span class="result-value">${rx_power_dbm.toFixed(2)}</span> <span style="color:${unit_color};">dBm</span><br>
        <span style="font-size:14px;color:var(--muted);">
            è·¯å¾‘æè€— (Path Loss): ${fspl_db.toFixed(2)} dB (FSPL) + ${(tx_loss_db + rx_loss_db).toFixed(2)} dB (ç·šæ) = ${(fspl_db + tx_loss_db + rx_loss_db).toFixed(2)} dB<br>
            ç™¼å°„ EIRP: ${(tx_power_dbm - tx_loss_db + tx_gain_dbi).toFixed(2)} dBm
        </span>
    `;
}


// --- åˆå§‹åŒ–åŸ·è¡Œ ---
document.addEventListener('DOMContentLoaded', () => {
    // åˆå§‹è¨ˆç®—æ‰€æœ‰é¡¯ç¤ºçš„å€å¡Š
    toggleSections(); 
});
</script>


</main>

<script>
  // --- Tab åˆ‡æ›åŠŸèƒ½ ---
  function showTab(tabId) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    // ä¿®æ­£: ä½¿ç”¨ data-tab å±¬æ€§é€²è¡Œæ›´ç©©å®šçš„é¸æ“‡
    const clickedButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
    if(clickedButton) clickedButton.classList.add('active');
    
    const tabContent = document.getElementById(tabId + '-content');
    if(tabContent) tabContent.classList.add('active');

    // ç¢ºä¿åˆ‡æ›æ™‚åŸ·è¡Œè¨ˆç®—
    if (tabId === 'rf') {
      compute();
    } else if (tabId === 'gps') {
      calculate(); 
    }
  }

  // --- å°„é »ç·šè¨ˆç®—å™¨ (RF Calculator) JS ---
  const cables = [
    { name: "LMR-600", a: 0.07555, b: 0.00026 },
    { name: "TCOM-600", a: 0.080075, b: 0.000256 },
    { name: "LMR-600-UF", a: 0.09066, b: 0.000312 },
    { name: "LMR-400", a: 0.12229, b: 0.00026 },
    { name: "LMR-400-UF", a: 0.146748, b: 0.000312 },
    { name: "M17/RG214", a: 0.21, b: 0.00126 },
    { name: "M17/RG142", a: 0.368, b: 0.0012 },
    // ä¿®æ­£å¾Œçš„ç·šæ LSSB-RG214
    { name: "LSSB-RG214", a: 0.191365, b: 0.001895 },
    // æ–°å¢ç·šæ LSSB-RG58
    { name: "LSSB-RG58", a: 0.444971, b: 0.003370 }
  ];
  
  // *** æ–°å¢å…¨åŸŸè®Šæ•¸ä¾†è¿½è¹¤ä¸Šä¸€æ¬¡çš„å–®ä½é¸æ“‡ ***
  let lastUnit = 'm'; 
  const FT_PER_METER = 3.28084; // 1 å…¬å°º = 3.28084 è‹±å°º

  function calcAttenPer100ft(f,a,b){
    // è¡°æ¸›å…¬å¼: A = a * sqrt(f) + b * f
    return a * Math.sqrt(f) + b * f;
  }
  function ftFromLength(len,unit){
    return unit === "ft" ? len : len * FT_PER_METER;
  }
  
  // *** æ–°å¢é•·åº¦å–®ä½è½‰æ›åŠŸèƒ½ ***
  function convertLength() {
      const lenInput = document.getElementById("lenInput");
      let len = parseFloat(lenInput.value);
      const newUnit = document.getElementById("unit").value;

      if (isNaN(len) || len === 0) {
          lastUnit = newUnit;
          compute();
          return;
      }

      if (lastUnit === 'm' && newUnit === 'ft') {
          // å…¬å°º -> è‹±å°º
          len *= FT_PER_METER;
      } else if (lastUnit === 'ft' && newUnit === 'm') {
          // è‹±å°º -> å…¬å°º
          len /= FT_PER_METER;
      }

      // å°‡æ›ç®—çµæœå¯«å›è¼¸å…¥æ¬„ä½ï¼Œä¿ç•™å°æ•¸é»å¾Œ 2 ä½
      lenInput.value = len.toFixed(2); 
      lastUnit = newUnit; 
      compute();
  }

  function powerPassPercent(db){
    return Math.pow(10, -db / 10) * 100;
  }

  function compute(){
    const f = parseFloat(document.getElementById("freq").value) || 0;
    const len = parseFloat(document.getElementById("lenInput").value) || 0;
    const unit = document.getElementById("unit").value || "m";
    const ftLen = ftFromLength(len, unit); // é•·åº¦ (è‹±å°º)
    
    // è¨ˆç®—é•·åº¦ (å…¬å°º)
    const mLen = unit === "m" ? len : len / FT_PER_METER; 
    
    let alternateDisplay;

    if (unit === "m") {
        // ä¸»è¦é¡¯ç¤º: å…¬å°º (m)ã€‚è¼”åŠ©é¡¯ç¤º: è‹±å°º (ft)
        alternateDisplay = `(${ftLen.toFixed(2)} ft)`;
    } else { // unit === "ft"
        // ä¸»è¦é¡¯ç¤º: è‹±å°º (ft)ã€‚è¼”åŠ©é¡¯ç¤º: å…¬å°º (m)
        alternateDisplay = `(${mLen.toFixed(2)} m)`;
    }

    // *** é€™è£¡ä¿®æ”¹äº† liveInputs çš„é¡¯ç¤ºå…§å®¹ ***
    document.getElementById("liveInputs").innerText =
      `${f} MHz â€¢ ${len.toFixed(2)} ${unit} ${alternateDisplay}`;
      
    // æ›´æ–° lastUnitï¼Œç¢ºä¿ä¸‹æ¬¡åˆ‡æ›æ™‚çš„èµ·é»æ­£ç¢º
    lastUnit = unit; 

    const results = cables.map(c=>{
      const per100 = calcAttenPer100ft(f, c.a, c.b);
      const total = per100 * (ftLen / 100);

      const pass = powerPassPercent(total);
      const loss = 100 - pass;

      return {
        name: c.name,
        // ä¿ç•™åˆ°å°æ•¸é»å¾Œ 6 ä½é€²è¡Œè¨ˆç®—ï¼Œé¿å…ç´¯ç©èª¤å·®
        total: Number(total.toFixed(6)), 
        pass: pass,
        loss: loss
      };
    });

    results.sort((x,y)=> x.total - y.total);

    let html =
      "<table><thead><tr>" +
      "<th>ç·šæ</th>" +
      "<th>è¡°æ¸› (dB)</th>" +
      "<th>é€šéåŠŸç‡ (%)</th>" +
      "<th>è¡°æ¸›åŠŸç‡ (%)</th>" +
      "</tr></thead><tbody>";

    results.forEach(r=>{
      html += `
        <tr>
          <td class="name">${r.name}</td>
          <td class="value">${r.total.toFixed(3)}</td> 
          <td class="percent">${r.pass.toFixed(1)}</td>
          <td class="percent">${r.loss.toFixed(1)}</td>
        </tr>`;
    });

    html += "</tbody></table>";

    document.getElementById("tableArea").innerHTML = html;
  }

  // --- æ¸…é™¤å–®ä¸€ RF è¼¸å…¥æ¬„ä½åŠŸèƒ½ ---
  function clearRfInput(id) {
    document.getElementById(id).value = '';
    // æ¸…é™¤è¼¸å…¥å¾Œç«‹å³é‡æ–°è¨ˆç®—ä»¥æ›´æ–°çµæœè¡¨æ ¼
    compute(); 
  }
  
  // RF é è¨­æŒ‰éˆ•åŠŸèƒ½
  function resetRf(){
    document.getElementById("freq").value = 900;
    document.getElementById("lenInput").value = 10;
    document.getElementById("unit").value = "m";
    // ç¢ºä¿ lastUnit èˆ‡é è¨­å€¼åŒæ­¥
    lastUnit = 'm'; 
    compute();
  }

  // RF æ¸…é™¤æŒ‰éˆ•åŠŸèƒ½
  function clearRf(){
    document.getElementById("freq").value = "";
    document.getElementById("lenInput").value = "";
    // å‘¼å« compute() è™•ç† liveInputs å’Œ tableArea çš„æ›´æ–°
    document.getElementById("unit").value = "m"; // å–®ä½é è¨­ç‚º m
    compute(); 
  }
  
  // --- GPS è¨ˆç®—å™¨ (GPS Calculator) JS ---
  const R_KM = 6371; 
  const tRad = a => a * (Math.PI / 180); 
  const tDeg = r => r * (180 / Math.PI); 

  // DD to DMS è½‰æ›
  const dToDMS = (id) => {
    const ddInput = document.getElementById(id);
    const dd = parseFloat(ddInput.value);
    
    if (isNaN(dd) || ddInput.value.trim() === '') {
        ['deg', 'min', 'sec'].forEach(s => document.getElementById(id + '_' + s).value = '');
        return;
    }
    
    const absDD = Math.abs(dd);
    const deg = Math.floor(absDD);
    
    // è¨ˆç®—å‰©é¤˜çš„å°æ•¸éƒ¨åˆ† (åˆ†)
    let minFloat = (absDD - deg) * 60;
    const min = Math.floor(minFloat);
    
    // è¨ˆç®—å‰©é¤˜çš„å°æ•¸éƒ¨åˆ† (ç§’)
    let sec = (minFloat - min) * 60;
    
    // ä¿®æ­£ï¼šç§’æ•¸å››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œå…©ä½ (toFixed(2) æœƒè‡ªå‹•å››æ¨äº”å…¥)
    sec = Number(sec.toFixed(2)); 

    let finalMin = min;
    let finalSec = sec;
    let finalDeg = deg;

    // è™•ç†ç§’æ•¸é€²ä½åˆ°åˆ†
    if (finalSec >= 60) {
      finalMin += Math.floor(finalSec / 60);
      finalSec = finalSec % 60;
      // ç¢ºä¿ finalSec ä»ä¿æŒå…©ä½å°æ•¸
      finalSec = Number(finalSec.toFixed(2));
    }
    
    // è™•ç†åˆ†é˜é€²ä½åˆ°åº¦
    if (finalMin >= 60) {
      finalDeg += Math.floor(finalMin / 60);
      finalMin = finalMin % 60;
    }

    document.getElementById(id + '_deg').value = (dd < 0 ? -finalDeg : finalDeg);
    document.getElementById(id + '_min').value = finalMin;
    // ä¿®æ­£ï¼šç¢ºä¿ç§’æ•¸é¡¯ç¤ºç‚ºå…©ä½å°æ•¸ (å¦‚ 24.40)
    document.getElementById(id + '_sec').value = finalSec.toFixed(2);
  };

  // DMS to DD è½‰æ›
  const dmsToD = (id) => {
    const d = parseFloat(document.getElementById(id + '_deg').value);
    const m = parseFloat(document.getElementById(id + '_min').value) || 0;
    const s = parseFloat(document.getElementById(id + '_sec').value) || 0;
    
    if (isNaN(d) && !m && !s) { document.getElementById(id).value = ''; return; }
    
    const sign = (d < 0) ? -1 : 1;
    // ç¢ºä¿åº¦/åˆ†/ç§’éƒ½æ˜¯æ­£æ•¸å†é€²è¡Œè¨ˆç®—ï¼Œæœ€å¾Œæ‡‰ç”¨ç¬¦è™Ÿ
    const dd = sign * (Math.abs(d) + Math.abs(m) / 60 + Math.abs(s) / 3600);
    if (!isNaN(dd)) { 
      document.getElementById(id).value = dd.toFixed(6); // DMS è¼¸å…¥æ™‚ï¼ŒDD æ¬„ä½å¼·åˆ¶æ ¼å¼åŒ–
    } else { 
      document.getElementById(id).value = ''; 
    }
  };
  
  // æ¸…é™¤å–®çµ„åº§æ¨™ (ç·¯åº¦/ç¶“åº¦) - åƒ…æ¸…é™¤åº§æ¨™
  const clearCoord = (idPrefix) => {
    document.getElementById(idPrefix).value = '';
    ['deg', 'min', 'sec'].forEach(s => document.getElementById(idPrefix + '_' + s).value = '');
    calculate();
  };

  // æ¸…é™¤é«˜åº¦è¼¸å…¥æ¬„ä½
  const clearElevation = (suffix) => {
    document.getElementById('ele' + suffix).value = '';
    calculate();
  };
  
  // *** æ–°å¢: åªæ¸…é™¤åœ°åæ¬„ä½ ***
  const clearNameOnly = (suffix) => {
    document.getElementById('name' + suffix).value = '';
  };

  // æ¸…é™¤ A/B é»æ‰€æœ‰æ¬„ä½ (åœ°å, ç·¯åº¦, ç¶“åº¦, é«˜åº¦) - ä¾› clearAllGps å…§éƒ¨ä½¿ç”¨
  const clearAllCoord = (suffix) => {
    const latPrefix = 'lat' + suffix;
    const lonPrefix = 'lon' + suffix;

    document.getElementById('name' + suffix).value = '';

    document.getElementById(latPrefix).value = '';
    ['deg', 'min', 'sec'].forEach(s => document.getElementById(latPrefix + '_' + s).value = '');

    document.getElementById(lonPrefix).value = '';
    ['deg', 'min', 'sec'].forEach(s => document.getElementById(lonPrefix + '_' + s).value = '');

    document.getElementById('ele' + suffix).value = '';
    
    calculate();
  };

  // GPS é è¨­æŒ‰éˆ•åŠŸèƒ½
  const resetGps = () => {
    document.getElementById('latA').value = '23.123456'; 
    document.getElementById('lonA').value = '122.654321'; 
    document.getElementById('eleA').value = '50'; 
    document.getElementById('nameA').value = 'æ³°å±±å£“é ‚'; 
    document.getElementById('latB').value = '24.123456'; 
    document.getElementById('lonB').value = '121.654321'; 
    document.getElementById('eleB').value = '2000'; 
    document.getElementById('nameB').value = 'å…‰æ˜é ‚'; 
    
    // åŸ·è¡Œè½‰æ›å’Œè¨ˆç®— (ç¢ºä¿ DMS æ¬„ä½ä¹ŸåŒæ­¥)
    const mode = document.getElementById('displayMode').value;
    if (mode === 'dms') {
        dToDMS('latA'); dToDMS('lonA'); dToDMS('latB'); dToDMS('lonB');
    } 
    
    calculate(); 
  };

  // GPS æ¸…é™¤æŒ‰éˆ•åŠŸèƒ½ (å…¨éƒ¨æ¸…é™¤)
  const clearAllGps = () => {
    clearAllCoord('A');
    clearAllCoord('B');
    // æ¸…é™¤çµæœå€å¡Š
    document.getElementById('gpsRes').innerHTML = "é»æ“Šã€Œè¨ˆç®—ã€ä»¥é¡¯ç¤ºçµæœ";
    document.getElementById('gpsRes').classList.remove('gps-error');
  };

  // Haversine è·é›¢ (çƒé¢æŠ•å½±è·é›¢, km)
  const hDist = (lat1, lon1, lat2, lon2) => {
    const [rLat1, rLat2, dLat, dLon] = [tRad(lat1), tRad(lat2), tRad(lat2 - lat1), tRad(lon2 - lon1)];
    const a = Math.sin(dLat / 2)**2 + Math.cos(rLat1) * Math.cos(rLat2) * Math.sin(dLon / 2)**2;
    return R_KM * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  };
  
  // 3D ç›´ç·šè·é›¢ (km)
  const straightDist = (hD, eleA, eleB) => {
    const dH = (eleB - eleA) / 1000;
    return Math.sqrt(hD * hD + dH * dH);
  };

  // æ–¹ä½è§’ (Bearing, 0-360Â°)
  const getBearing = (lat1, lon1, lat2, lon2) => {
    const [rL1, rL2, dLon] = [tRad(lat1), tRad(lat2), tRad(lon2 - lon1)];
    const y = Math.sin(dLon) * Math.cos(rL2);
    const x = Math.cos(rL1) * Math.sin(rL2) - Math.sin(rL1) * Math.cos(rL2) * Math.cos(dLon);
    return (tDeg(Math.atan2(y, x)) + 360) % 360;
  };
  
  // ä¿¯ä»°è§’ (Pitch Angle, åº¦)
  const getPitch = (distKm, eleA, eleB) => {
    if (distKm === 0) return { pitchAB: 0, pitchBA: 0 };
    const [hA, hB] = [eleA / 1000, eleB / 1000];
    const offset = distKm**2 / (2 * R_KM); 
    
    const H_AB = (hB - hA) - offset;
    const pitchAB = tDeg(Math.atan2(H_AB, distKm));
    
    const H_BA = (hA - hB) - offset;
    const pitchBA = tDeg(Math.atan2(H_BA, distKm));

    return { pitchAB, pitchBA };
  };


  // ä¸»è¨ˆç®—å‡½æ•¸
  function calculate() {
    // ç•¶å‰æ¨¡å¼ç‚º DMS æ™‚ï¼Œå…ˆå¾ DMS è½‰æ›åˆ° DD (ç¢ºä¿è¨ˆç®—ä½¿ç”¨æœ€æ–°çš„ DD å€¼)
    const mode = document.getElementById('displayMode').value;
    if (mode === 'dms') {
        ['latA','lonA','latB','lonB'].forEach(id => { try{ dmsToD(id); }catch(e){} });
    }
    
    const [latA, lonA, latB, lonB, eleA, eleB] = 
        ['latA', 'lonA', 'latB', 'lonB', 'eleA', 'eleB'].map(id => parseFloat(document.getElementById(id).value || 0));
    
    const [nameA, nameB] = 
        ['nameA', 'nameB'].map(id => document.getElementById(id).value || (id === 'nameA' ? 'A' : 'B'));

    const resDiv = document.getElementById('gpsRes');

    if (isNaN(latA) || isNaN(lonA) || isNaN(latB) || isNaN(lonB)) {
        resDiv.innerHTML = "âŒ **è«‹è¼¸å…¥æœ‰æ•ˆçš„ GPS åº§æ¨™æ•¸å­—**";
        resDiv.classList.add('gps-error');
        return;
    }
    resDiv.classList.remove('gps-error');

    const hD = hDist(latA, lonA, latB, lonB);
    const sD = straightDist(hD, eleA, eleB);
    const bAB = getBearing(latA, lonA, latB, lonB);
    const bBA = getBearing(latB, lonB, latA, lonA); 
    const pitch = getPitch(hD, eleA, eleB);
    
    // æ•¸å€¼å°‡ç¹¼æ‰¿é’ç¶ è‰²æ¨£å¼
    const fDist = sD < 1 
        ? `<strong class="v-dist">${(sD * 1000).toFixed(2)}</strong> å…¬å°º`
        : `<strong class="v-dist">${sD.toFixed(2)}</strong> å…¬é‡Œ`;
    
    // é¡¯ç¤ºçµæœ
    resDiv.innerHTML = `
        <p><span class="gps-label-title">âœ… å…©é»é–“çš„ç›´ç·šè·é›¢</span>ï¼š${fDist}</p>
        <hr>
        <p><span class="gps-label-title">ğŸ§­ å¾ ${nameA} åˆ° ${nameB} çš„æ–¹ä½è§’</span>ï¼š<strong class="v-bearing">${bAB.toFixed(2)}Â°</strong></p>
        <p><span class="gps-label-title">â†©ï¸ å¾ ${nameB} åˆ° ${nameA} çš„æ–¹ä½è§’</span>ï¼š<strong class="v-bearing">${bBA.toFixed(2)}Â°</strong></p>
        <hr style="border: 0; border-top: 1px dashed rgba(255,255,255,0.06); margin: 3px 0;">
        <p><span class="gps-label-title">â« ${nameA} å° ${nameB} çš„ä¿¯ä»°è§’</span>ï¼š<strong class="v-pitch-value">${pitch.pitchAB.toFixed(2)}Â°</strong></p>
        <p><span class="gps-label-title">â¬ ${nameB} å° ${nameA} çš„ä¿¯ä»°è§’</span>ï¼š<strong class="v-pitch-value">${pitch.pitchBA.toFixed(2)}Â°</strong></p>
    `;
  }
  
  // --- é¡¯ç¤ºæ¨¡å¼åˆ‡æ›ï¼ˆåé€²åˆ¶ / åº¦åˆ†ç§’ï¼‰ ---
    const displayModeSelect = document.getElementById('displayMode');
    
    function updateDisplayMode(mode){
      if(!mode) mode = displayModeSelect ? displayModeSelect.value : 'decimal';
      
      const ids = ['latA','lonA','latB','lonB'];
      
      if(mode === 'dms'){
        // é¡¯ç¤º DMS æ¬„ä½ï¼Œéš±è—åé€²åˆ¶æ¬„ä½
        document.querySelectorAll('.gps-dmsr').forEach(el => el.style.display = 'flex');
        document.querySelectorAll('.gps-ddr').forEach(el => el.style.display = 'none');
        
        // å°‡ç¾æœ‰åé€²åˆ¶è½‰ç‚º DMS é¡¯ç¤º
        ids.forEach(id => { 
            try{ dToDMS(id); }catch(e){} 
        });
      } else {
        // é¡¯ç¤ºåé€²åˆ¶æ¬„ä½ï¼Œéš±è— DMS æ¬„ä½
        document.querySelectorAll('.gps-dmsr').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.gps-ddr').forEach(el => el.style.display = 'flex');
        
        // ä¿®æ­£ 1: åƒ…åœ¨ DD æ¬„ä½ç‚ºç©ºæ™‚ï¼Œæ‰å°‡ DMS å€¼è½‰å› DD
        ids.forEach(id => { 
            const ddInput = document.getElementById(id);
            if (ddInput.value.trim() === '') {
                try{ dmsToD(id); }catch(e){} 
            } 
        });
      }
      
      // æ¨¡å¼åˆ‡æ›å¾Œç«‹å³è¨ˆç®—çµæœ
      calculate(); 
    }
    
    if(displayModeSelect){
      displayModeSelect.addEventListener('change', e => updateDisplayMode(e.target.value));
    }

  // --- åˆå§‹åŒ–è¨­å®šèˆ‡åŸ·è¡Œ ---
  document.addEventListener('DOMContentLoaded', () => {
    // *** æ–°å¢ RF å–®ä½åˆ‡æ›çš„ç›£è½å™¨ ***
    document.getElementById('unit').addEventListener('change', convertLength);

    // 1. RF è¨ˆç®—å™¨åˆå§‹åŒ– (RF é è¨­ç‚º active)
    if (document.getElementById('rf-content').classList.contains('active')) {
      compute();
    }
    
    // 2. GPS è¨ˆç®—å™¨åˆå§‹åŒ–é è¨­å€¼
    resetGps(); 
    
    // ç¢ºä¿æ­£ç¢ºé¡¯ç¤ºåˆå§‹æ¨¡å¼ (é è¨­ç‚º decimal)
    try { updateDisplayMode(document.getElementById('displayMode').value || 'decimal'); } catch(e){}
    
  });
</script>



<!-- RFå·¥å…·_OK.js (æ’å…¥è‡ª RFå·¥å…·_OK.html) -->
<script>

// æ‰€æœ‰è¨ˆç®—æ¨¡çµ„çš„ ID æ˜ å°„
const sectionIds = {
    'power': 'section-power',
    'matching': 'section-matching',
    'sensitivity': 'section-sensitivity',
    'los': 'section-los',
    'fspl': 'section-fspl',
    'linkbudget': 'section-linkbudget'
};

// --- æ–°å¢é è¨­/æ¸…é™¤åŠŸèƒ½ ---

// 1. é è¨­å€¼èˆ‡è¨ˆç®—å‡½æ•¸æ˜ å°„
const defaultValues = {
    // 1. åŠŸç‡è½‰æ› (dBm / W)
    'section-power': {
        'power_input': '1',
        'power_unit': 'w',
    },
    // 2. åŒ¹é…åº¦åƒæ•¸æ›ç®—
    'section-matching': {
        'matching_input_value': '20',
        'matching_unit': 'rl',
    },
    // 3. ç³»çµ±éˆæ•åº¦ (Sensitivity) è¨ˆç®—
    'section-sensitivity': {
        'sensitivity_bw': '1',
        'sensitivity_nf': '5',
        'sensitivity_sn': '10',
    },
    // 4. é€šè¦–æœ€å¤§è·é›¢è¨ˆç®—
    'section-los': {
        'los_g1': '0',
        'los_h1': '10',
        'los_g2': '0',
        'los_h2': '20',
    },
    // 5. è‡ªç”±ç©ºé–“æè€— (FSPL)
    'section-fspl': {
        'fspl_freq': '2400',
        'fspl_dist': '10',
    },
    // 6. é€šè¨Šæ¨¡æ“¬ (Link Budget)
    'section-linkbudget': {
        'link_tx_power_input': '1',
        'link_tx_power_unit': 'w',
        'link_tx_loss_db': '3',
        'link_tx_gain_dbi': '20',
        'link_dist_km': '10',
        'link_freq_mhz': '2400',
        'link_rx_gain_dbi': '20',
        'link_rx_loss_db': '2',
    }
};

const calculationFunctions = {
    'section-power': 'calculateDbmWNew',
    'section-matching': 'calculateMatching',
    'section-sensitivity': 'calculateSensitivity',
    'section-los': 'calculateMaxLOS',
    'section-fspl': 'calculateFSPL',
    'section-linkbudget': 'calculateLinkBudget',
};

/**
 * å–å¾—æŒ‡å®šå€å¡Šä¸­æ‰€æœ‰éœ€è¦æ§åˆ¶çš„è¼¸å…¥æ¬„ä½ (input, select)
 * @param {string} sectionId å€å¡Š ID
 * @returns {HTMLElement[]} å…ƒç´ é™£åˆ—
 */
function getSectionControls(sectionId) {
    const sectionEl = document.getElementById(sectionId);
    if (!sectionEl) return [];
    
    // é™åˆ¶åœ¨ .input-group-border å…§ï¼Œæ’é™¤ä¸»åŠŸèƒ½é¸æ“‡å™¨
    const inputGroup = sectionEl.querySelector('.input-group-border');
    if (!inputGroup) return [];

    // å–å¾—æ‰€æœ‰å…·æœ‰ ID çš„ input å’Œ select å…ƒç´ 
    return Array.from(inputGroup.querySelectorAll('input, select')).filter(el => el.id);
}

/**
 * å°‡æŒ‡å®šå€å¡Šæ‰€æœ‰æ•¸å€¼å›å¾©æˆé è¨­å€¼ (Reset)
 * @param {string} sectionId å€å¡Š ID
 */
function resetSection(sectionId) {
    const defaults = defaultValues[sectionId];
    if (defaults) {
        // è¿­ä»£é è¨­å€¼åˆ—è¡¨ï¼Œè¨­å®šå…ƒç´ å€¼
        for (const id in defaults) {
            const element = document.getElementById(id);
            if (element) {
                element.value = defaults[id];
                // ç¢ºä¿æ•¸å€¼è¼¸å…¥æ¬„ä½å¯ä»¥æ¥å—ç©ºå­—ä¸² (Clear)
                if(element.tagName === 'INPUT') element.value = defaults[id];
            }
        }
    }
    // åŸ·è¡Œè¨ˆç®—
    const calcFunc = calculationFunctions[sectionId];
    if (calcFunc && typeof window[calcFunc] === 'function') {
        window[calcFunc]();
    }
}

/**
 * æ¸…é™¤æŒ‡å®šå€å¡Šæ‰€æœ‰æ•¸å€¼ (Clear)
 * - è¼¸å…¥æ¬„ä½è¨­å®šç‚ºç©ºå­—ä¸² ''
 * - å–®ä½é¸æ“‡å™¨è¨­å®šå›é è¨­ functional default (èˆ‡ reset ç›¸åŒçš„å€¼)
 * @param {string} sectionId å€å¡Š ID
 */
function clearSection(sectionId) {
    const controls = getSectionControls(sectionId);
    const defaults = defaultValues[sectionId] || {}; // ç”¨æ–¼å–å¾— Select çš„é è¨­å€¼

    controls.forEach(element => {
        const id = element.id;
        if (element.tagName === 'INPUT') {
            element.value = ''; // æ¸…é™¤è¼¸å…¥æ¡†æ•¸å€¼
        } else if (element.tagName === 'SELECT') {
            // å–®ä½é¸æ“‡å™¨ (Select) æ‡‰è¨­å®šå›é è¨­åŠŸèƒ½å€¼ (é¿å…ç„¡æ•ˆé¸é …å°è‡´éŒ¯èª¤)
            if (defaults[id]) {
                element.value = defaults[id];
            } else {
                element.selectedIndex = 0; 
            }
        }
    });
    
    // åŸ·è¡Œè¨ˆç®—
    const calcFunc = calculationFunctions[sectionId];
    if (calcFunc && typeof window[calcFunc] === 'function') {
        window[calcFunc]();
    }
}
// --- çµæŸæ–°å¢ ---

// --- åŠŸèƒ½åˆ‡æ›å‡½æ•¸ --- 
function toggleSections() { 
    const selector = document.getElementById('function_selector'); 
    const selectedValue = selector.value; 
    const allSections = document.querySelectorAll('.section-item'); 
    allSections.forEach(section => { 
        const sectionKey = Object.keys(sectionIds).find(key => sectionIds[key] === section.id); 
        if (selectedValue === 'ALL') { 
            section.style.display = 'block'; 
        } else if (sectionKey === selectedValue) { 
            section.style.display = 'block'; 
        } else { 
            section.style.display = 'none'; 
        } 
    }); 
    // ç¢ºä¿åœ¨åˆ‡æ›æ™‚ï¼Œç•«é¢æœƒé‡æ–°è¨ˆç®—ä¸¦é¡¯ç¤ºçµæœ (å¦‚æœæ¨¡çµ„è¢«é¡¯ç¤º) 
    if (selectedValue === 'ALL' || selectedValue === 'power') calculateDbmWNew(); 
    if (selectedValue === 'ALL' || selectedValue === 'matching') calculateMatching(); 
    if (selectedValue === 'ALL' || selectedValue === 'sensitivity') calculateSensitivity(); 
    if (selectedValue === 'ALL' || selectedValue === 'los') calculateMaxLOS();
    if (selectedValue === 'ALL' || selectedValue === 'fspl') calculateFSPL();
    if (selectedValue === 'ALL' || selectedValue === 'linkbudget') calculateLinkBudget();
}

/**
 * å€‹åˆ¥è¼¸å…¥æ¬„ä½æ¸…é™¤ä¸¦é‡æ–°è¨ˆç®—
 * @param {string} inputId è¼¸å…¥æ¬„ä½ ID
 * @param {string} calcFunc è¨ˆç®—å‡½æ•¸åç¨±
 */
function clearAndRecalculate(inputId, calcFunc) {
    const inputElement = document.getElementById(inputId);
    if (inputElement) {
        inputElement.value = '';
    }
    if (typeof window[calcFunc] === 'function') {
        window[calcFunc]();
    }
}

// --- 1. åŠŸç‡è½‰æ› (dBm / W) ---
// è¼”åŠ©å‡½æ•¸ï¼šåŸ·è¡Œ dBm <-> W è½‰æ›
function convertPower(value, fromUnit, toUnit) {
    if (fromUnit === toUnit) return value;
    if (fromUnit === 'w' && toUnit === 'dbm') {
        // W to dBm: 10 * log10(P_W / 1mW) = 10 * log10(P_W * 1000)
        return 10 * Math.log10(value * 1000);
    } else if (fromUnit === 'dbm' && toUnit === 'w') {
        // dBm to W: 10^(P_dBm / 10) * 1mW = 10^(P_dBm / 10 - 3)
        return Math.pow(10, (value / 10) - 3);
    }
    return NaN;
}

// ç”¨æ–¼è¨˜éŒ„ä¸Šä¸€æ¬¡è¼¸å…¥çš„å–®ä½ï¼Œä»¥åœ¨åˆ‡æ›å–®ä½æ™‚é€²è¡Œæ•¸å€¼æ›ç®—
let power_conv_last_unit = 'w'; 

function calculateDbmWNew() {
    const input = document.getElementById('power_input');
    const unit = document.getElementById('power_unit').value;
    const output = document.getElementById('power_output_result');
    const redColor = getComputedStyle(document.documentElement).getPropertyValue('--red-clear');
    const unit_color = getComputedStyle(document.body).color; // ä¸»è¦æ–‡å­—é¡è‰² (ç™½è‰²)

    const input_value = parseFloat(input.value);

    if (isNaN(input_value) || input.value.trim() === '') {
        output.innerHTML = `æ›ç®—çµæœ: <span style="color:${redColor};">è«‹è¼¸å…¥æ•¸å€¼</span>`;
        return;
    }
    
    // æª¢æŸ¥æ•¸å€¼ç¯„åœ
    if (unit === 'w' && input_value < 0) {
        output.innerHTML = `æ›ç®—çµæœ: <span style="color:${redColor};">åŠŸç‡ (W) å¿…é ˆ â‰¥ 0</span>`;
        return;
    }

    let result_value, result_unit;

    if (unit === 'w') {
        result_value = convertPower(input_value, 'w', 'dbm');
        result_unit = 'dBm';
        // é¡å¤–æª¢æŸ¥ dBm è½‰æ›æ˜¯å¦æœ‰æ•ˆ (åªæœ‰ 0 W æœƒæ˜¯ -Infinity)
        if (result_value === -Infinity) {
            output.innerHTML = `æ›ç®—çµæœ: <span class="result-value">-âˆ</span> <span style="color:${unit_color};">${result_unit}</span>`;
            return;
        }
    } else { // unit === 'dbm'
        result_value = convertPower(input_value, 'dbm', 'w');
        result_unit = 'W';
        // æª¢æŸ¥ W è½‰æ›æ˜¯å¦æœ‰æ•ˆ (æ¥µå°çš„æ•¸å€¼)
        if (result_value < 0) result_value = 0;
    }
    
    if (isNaN(result_value)) {
        output.innerHTML = `æ›ç®—çµæœ: <span style="color:${redColor};">è¼¸å…¥ç„¡æ•ˆ</span>`;
        return;
    } else {
        // è¼¸å‡ºæ•¸å€¼ï¼Œå–®ä½å¥—ç”¨ç™½è‰²
        output.innerHTML = `æ›ç®—çµæœ: <span class="result-value">${result_value.toFixed(3)}</span> <span style="color:${unit_color};">${result_unit}</span>`;
    }
    power_conv_last_unit = unit;
}

function swapAndCalculate() {
    const input = document.getElementById('power_input');
    const current_unit = document.getElementById('power_unit').value;
    const input_value = parseFloat(input.value);

    if (!isNaN(input_value) && input.value.trim() !== '') {
        const new_value = convertPower(input_value, power_conv_last_unit, current_unit);
        if (!isNaN(new_value)) {
            // è™•ç† 0 W è½‰æ›ç‚º -Infinity dBm çš„æƒ…æ³
            if (current_unit === 'dbm' && new_value === -Infinity) {
                // å¦‚æœå–®ä½åˆ‡æ›åˆ° dBm ä¸”åŸå€¼ç‚º 0 Wï¼Œä¸æ”¹è®Š input.valueï¼Œè®“ calculateDbmWNew è™•ç†è¼¸å‡º
            } else {
                input.value = new_value.toFixed(3);
            }
        } else {
             // è™•ç†è¼¸å…¥ç„¡æ•ˆå°è‡´çš„ NaNï¼Œä½†å¦‚æœåŸå€¼æ˜¯æœ‰æ•ˆçš„ï¼Œé€™è£¡ä¸æ‡‰æ¸…é™¤
        }
    }
    calculateDbmWNew();
}


// --- 2. åŒ¹é…åº¦è½‰æ› (å‹•æ…‹æ›ç®—é‚è¼¯) ---
let last_matching_unit = 'rl'; 

function getGammaFromValue(value, type) {
    if (type === 'rl') {
        if (value < 0) throw new Error("RL å¿…é ˆ â‰¥ 0 dB");
        return Math.pow(10, -value / 20);
    } else if (type === 'vswr') {
        if (value < 1) throw new Error("VSWR å¿…é ˆ â‰¥ 1");
        return (value - 1) / (value + 1);
    } else if (type === 'gamma') {
        if (value < 0 || value > 1) throw new Error("Î“ å¿…é ˆä»‹æ–¼ 0 åˆ° 1 ä¹‹é–“");
        return value;
    } else if (type === 'refl_pct') {
        if (value < 0 || value > 100) throw new Error("åå°„åŠŸç‡å¿…é ˆä»‹æ–¼ 0 åˆ° 100 ä¹‹é–“");
        return Math.sqrt(value / 100);
    } else if (type === 'pass_pct') {
        if (value < 0 || value > 100) throw new Error("é€šéåŠŸç‡å¿…é ˆä»‹æ–¼ 0 åˆ° 100 ä¹‹é–“");
        return Math.sqrt(1 - (value / 100));
    }
    return NaN;
}

function getValueFromGamma(gamma, type) {
    if (isNaN(gamma) || gamma === Infinity) return NaN;

    if (type === 'rl') {
        // -20 * log10(|Î“|)
        if (gamma === 0) return Infinity;
        // ç¢ºä¿è¼¸å…¥æ˜¯æ­£æ•¸ä»¥é¿å… Math.log10 éŒ¯èª¤
        return -20 * Math.log10(Math.abs(gamma));
    } else if (type === 'vswr') {
        // (1 + |Î“|) / (1 - |Î“|)
        if (gamma === 1) return Infinity;
        return (1 + Math.abs(gamma)) / (1 - Math.abs(gamma));
    } else if (type === 'gamma') {
        return Math.abs(gamma);
    } else if (type === 'refl_pct') {
        // |Î“|^2 * 100%
        return Math.abs(gamma)**2 * 100;
    } else if (type === 'pass_pct') {
        // (1 - |Î“|^2) * 100%
        return (1 - Math.abs(gamma)**2) * 100;
    }
    return NaN;
}

function swapAndConvertMatching() {
    const current_unit = document.getElementById('matching_unit').value;
    const input_element = document.getElementById('matching_input_value');
    const input_value = parseFloat(input_element.value);

    // åªæœ‰åœ¨è¼¸å…¥æ•¸å€¼æœ‰æ•ˆæ™‚æ‰å˜—è©¦æ›ç®—
    if (!isNaN(input_value) && input_element.value.trim() !== '') {
        let gamma_abs;
        try {
            // 1. å¾èˆŠå–®ä½æ›ç®—åˆ°çµ•å°å€¼åå°„ä¿‚æ•¸ |Î“|
            gamma_abs = getGammaFromValue(input_value, last_matching_unit);
            if (!isNaN(gamma_abs)) {
                // 2. å°‡ |Î“| æ›ç®—æˆæ–°å–®ä½çš„å€¼
                const new_value = getValueFromGamma(gamma_abs, current_unit);
                if (!isNaN(new_value) && new_value !== Infinity) {
                    // å¦‚æœæ–°å–®ä½æ˜¯ RLï¼Œä¿ç•™ 2 ä½å°æ•¸ï¼Œå…¶ä»–ä¿ç•™ 4 ä½å°æ•¸
                    const precision = (current_unit === 'rl' || current_unit === 'refl_pct' || current_unit === 'pass_pct') ? 2 : 4;
                    input_element.value = new_value.toFixed(precision);
                } else if (new_value === Infinity) {
                    input_element.value = '1'; // VSWR/RL ç„¡çª®å¤§æ™‚ï¼Œåå°„ä¿‚æ•¸ç‚º 1
                } else {
                    input_element.value = '';
                }
            } else {
                input_element.value = '';
            }
        } catch (error) {
             input_element.value = '';
        }
    }
    calculateMatching();
    last_matching_unit = current_unit;
}

function calculateMatching() {
    const input_type = document.getElementById('matching_unit').value;
    const input_element = document.getElementById('matching_input_value');
    const input_value = parseFloat(input_element.value);
    
    const redColor = getComputedStyle(document.documentElement).getPropertyValue('--red-clear');
    const unit_color = getComputedStyle(document.body).color;

    const output_elements = {
        rl: document.getElementById('rl_val'),
        vswr: document.getElementById('vswr_val'),
        gamma: document.getElementById('gamma_val'),
        refl_pct: document.getElementById('refl_percent'),
        pass_pct: document.getElementById('pass_percent')
    };

    const empty_output = `<span style="color:${redColor};font-size:17px;">è«‹è¼¸å…¥æ•¸å€¼</span>`;

    // æ¸…ç©ºæ‰€æœ‰è¼¸å‡º
    Object.values(output_elements).forEach(el => el.innerHTML = '');

    if (isNaN(input_value) || input_element.value.trim() === '') {
        output_elements.rl.innerHTML = empty_output;
        return;
    }

    let gamma_abs;
    try {
        gamma_abs = getGammaFromValue(input_value, input_type);
    } catch (error) {
        output_elements.rl.innerHTML = `<span style="color:${redColor};font-size:17px;">${error.message}</span>`;
        return;
    }
    
    // è¼¸å‡ºæ›ç®—çµæœ
    const rl_val = getValueFromGamma(gamma_abs, 'rl');
    const vswr_val = getValueFromGamma(gamma_abs, 'vswr');
    const gamma_val = getValueFromGamma(gamma_abs, 'gamma');
    const refl_pct = getValueFromGamma(gamma_abs, 'refl_pct');
    const pass_pct = getValueFromGamma(gamma_abs, 'pass_pct');

    const formatOutput = (value, unit, precision=2) => {
        if (value === Infinity) return `<span class="result-value">âˆ</span> <span style="color:${unit_color};">${unit}</span>`;
        if (isNaN(value)) return `<span style="color:${redColor};font-size:17px;">è¨ˆç®—éŒ¯èª¤</span>`;
        return `<span class="result-value">${value.toFixed(precision)}</span> <span style="color:${unit_color};">${unit}</span>`;
    }

    output_elements.rl.innerHTML = formatOutput(rl_val, 'dB');
    output_elements.vswr.innerText = vswr_val === Infinity ? 'âˆ' : vswr_val.toFixed(3);
    output_elements.gamma.innerText = gamma_val.toFixed(4);
    output_elements.refl_pct.innerHTML = formatOutput(refl_pct, '%');
    output_elements.pass_pct.innerHTML = formatOutput(pass_pct, '%');

    last_matching_unit = input_type;
}

// --- 3. é€šä¿¡ç³»çµ±éˆæ•åº¦è¨ˆç®— ---
// è¼”åŠ©å¸¸æ•¸
const BOLTZMANN_K_J = 1.380649e-23; // J/K
const T_KELVIN = 290; // åƒè€ƒæº«åº¦ (290 K)
// é›œè¨Šåœ°æ¿ (Noise Floor) P_n (dBm) = -174 + 10 * log10(BW_Hz) + NF_dB
// P_n (dBm) = -174 + 10 * log10(BW_MHz * 10^6) + NF_dB
// P_n (dBm) = -174 + 10 * (log10(BW_MHz) + 6) + NF_dB
// P_n (dBm) = -174 + 10*log10(BW_MHz) + 60 + NF_dB
// P_n (dBm) = -114 + 10*log10(BW_MHz) + NF_dB

function calculateSensitivity() {
    const bw_mhz = parseFloat(document.getElementById('sensitivity_bw').value);
    const nf_db = parseFloat(document.getElementById('sensitivity_nf').value);
    const sn_db = parseFloat(document.getElementById('sensitivity_sn').value);
    const output = document.getElementById('sensitivity_output');
    const redColor = getComputedStyle(document.documentElement).getPropertyValue('--red-clear');
    const unit_color = getComputedStyle(document.body).color;

    if (isNaN(bw_mhz) || isNaN(nf_db) || isNaN(sn_db) || bw_mhz <= 0 || nf_db < 0) {
        output.innerHTML = `æ¥æ”¶å™¨éˆæ•åº¦ (Sensitivity): <span style="color:${redColor};">è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼ (BW > 0, NF â‰¥ 0)</span>`;
        return;
    }

    // 1. è¨ˆç®—ç†±é›œè¨Šåœ°æ¿ (Noise Floor) P_n (dBm)
    // P_n (dBm) = -174 + 10 * log10(BW_Hz) + NF_dB
    // ç°¡åŒ–ç‚ºï¼š -114 + 10*log10(BW_MHz) + NF_dB
    const noise_floor_dbm = -114 + (10 * Math.log10(bw_mhz)) + nf_db;

    // 2. è¨ˆç®—éˆæ•åº¦ (Sensitivity)
    // Sensitivity (dBm) = P_n (dBm) + S/N (dB)
    const sensitivity_dbm = noise_floor_dbm + sn_db;

    output.innerHTML = `
        æ¥æ”¶å™¨éˆæ•åº¦ (Sensitivity): <span class="result-value">${sensitivity_dbm.toFixed(2)}</span> <span style="color:${unit_color};">dBm</span><br>
        <span class="result-value-small">ç†±é›œè¨Šåœ°æ¿ (Noise Floor) Pn: ${noise_floor_dbm.toFixed(2)} dBm</span>
    `;
}

// --- 4. é€šè¦–æœ€å¤§è·é›¢è¨ˆç®— (åœ°çƒæ›²åº¦é®è”½) ---
// è¼”åŠ©å¸¸æ•¸
const K_FACTOR = 4 / 3; // K=4/3 (ç­‰æ•ˆåœ°çƒåŠå¾‘å¸¸æ•¸)
const R_EARTH_KM = 6371; // åœ°çƒåŠå¾‘ (km)

function calculateMaxLOS() {
    // è®€å–è¼¸å…¥å€¼ (å¤©ç·šé«˜åº¦ H + åœ°å¹³é¢é«˜åº¦ G = çµ•å°é«˜åº¦ A)
    const g1 = parseFloat(document.getElementById('los_g1').value) || 0;
    const h1 = parseFloat(document.getElementById('los_h1').value) || 0;
    const g2 = parseFloat(document.getElementById('los_g2').value) || 0;
    const h2 = parseFloat(document.getElementById('los_h2').value) || 0;

    const output = document.getElementById('los_output');
    const redColor = getComputedStyle(document.documentElement).getPropertyValue('--red-clear');
    const unit_color = getComputedStyle(document.body).color;

    // æª¢æŸ¥é«˜åº¦æ˜¯å¦æœ‰æ•ˆ
    if (h1 < 0 || h2 < 0) {
        output.innerHTML = `æœ€å¤§é€šè¦–è·é›¢: <span style="color:${redColor};">å¤©ç·šé«˜åº¦å¿…é ˆ â‰¥ 0</span>`;
        return;
    }
    
    // çµ•å°é«˜åº¦ (m)
    const a1 = g1 + h1;
    const a2 = g2 + h2;
    
    // æª¢æŸ¥çµ•å°é«˜åº¦æ˜¯å¦æœ‰æ•ˆ
    if (a1 <= 0 || a2 <= 0) {
        output.innerHTML = `æœ€å¤§é€šè¦–è·é›¢: <span style="color:${redColor};">è«‹è¼¸å…¥æœ‰æ•ˆçš„ (å¤©ç·šçµ•å°é«˜åº¦ > 0) æ•¸å€¼</span>`;
        return;
    }

    // ç­‰æ•ˆåœ°çƒåŠå¾‘ (km)
    const R_eff = K_FACTOR * R_EARTH_KM; 
    
    // æœ€å¤§é€šè¦–è·é›¢å…¬å¼ (Distance D_km) = sqrt(2 * R_eff * A_1 / 1000) + sqrt(2 * R_eff * A_2 / 1000)
    // é€™è£¡ A_1, A_2 æ˜¯çµ•å°é«˜åº¦ (m)ï¼Œæ‰€ä»¥é™¤ä»¥ 1000 è½‰æ›ç‚º km
    const d1_km = Math.sqrt(2 * R_eff * a1 / 1000);
    const d2_km = Math.sqrt(2 * R_eff * a2 / 1000);

    const max_los_km = d1_km + d2_km;

    output.innerHTML = `
        æœ€å¤§é€šè¦–è·é›¢: <span class="result-value">${max_los_km.toFixed(2)}</span> <span style="color:${unit_color};">km</span><br>
        <span class="result-value-small">Aé»è¦–è·: ${d1_km.toFixed(2)} km; Bé»è¦–è·: ${d2_km.toFixed(2)} km</span>
    `;
}

// --- 5. è‡ªç”±ç©ºé–“æè€— (Free Space Path Loss, FSPL) ---
// FSPL (dB) = 20 log10(d) + 20 log10(f) + 20 log10(4Ï€/c)
// FSPL (dB) = 32.44 + 20 * log10(f_MHz) + 20 * log10(d_km)
function calculateFSPL() {
    const freq_mhz = parseFloat(document.getElementById('fspl_freq').value);
    const dist_km = parseFloat(document.getElementById('fspl_dist').value);
    const output = document.getElementById('fspl_output');
    const redColor = getComputedStyle(document.documentElement).getPropertyValue('--red-clear');
    const unit_color = getComputedStyle(document.body).color;

    if (isNaN(freq_mhz) || isNaN(dist_km) || freq_mhz <= 0 || dist_km <= 0) {
        output.innerHTML = `è‡ªç”±ç©ºé–“è¡°æ¸›é‡ (FSPL): <span style="color:${redColor};">è«‹è¼¸å…¥æœ‰æ•ˆçš„ (é »ç‡ > 0, è·é›¢ > 0) æ•¸å€¼</span>`;
        return;
    }

    // FSPL (dB) = 32.44 + 20 * log10(f_MHz) + 20 * log10(d_km)
    const fspl_db = 32.44 + (20 * Math.log10(freq_mhz)) + (20 * Math.log10(dist_km));
    
    output.innerHTML = `è‡ªç”±ç©ºé–“è¡°æ¸›é‡ (FSPL): <span class="result-value">${fspl_db.toFixed(2)}</span> <span style="color:${unit_color};">dB</span>`;
}

// --- 6. é€šè¨Šæ¨¡æ“¬ (Link Budget) ---
function calculateLinkBudget() {
    // é€šä¿¡åƒæ•¸
    const freq_mhz = parseFloat(document.getElementById('link_freq_mhz').value);
    const dist_km = parseFloat(document.getElementById('link_dist_km').value);

    // Tx ç«¯åƒæ•¸
    const tx_power_input = parseFloat(document.getElementById('link_tx_power_input').value);
    const tx_power_unit = document.getElementById('link_tx_power_unit').value;
    const tx_loss_db = parseFloat(document.getElementById('link_tx_loss_db').value) || 0;
    const tx_gain_dbi = parseFloat(document.getElementById('link_tx_gain_dbi').value) || 0;
    
    // Rx ç«¯åƒæ•¸
    const rx_gain_dbi = parseFloat(document.getElementById('link_rx_gain_dbi').value) || 0;
    const rx_loss_db = parseFloat(document.getElementById('link_rx_loss_db').value) || 0;
    
    const output = document.getElementById('linkbudget_output');
    const redColor = getComputedStyle(document.documentElement).getPropertyValue('--red-clear');
    const unit_color = getComputedStyle(document.body).color;

    // æª¢æŸ¥åŸºæœ¬è¼¸å…¥æœ‰æ•ˆæ€§
    if (isNaN(freq_mhz) || isNaN(dist_km) || freq_mhz <= 0 || dist_km <= 0) {
        output.innerHTML = `æ¥æ”¶è¨Šè™Ÿå¼·åº¦: <span style="color:${redColor};">è«‹è¼¸å…¥æœ‰æ•ˆçš„ (é »ç‡ > 0, è·é›¢ > 0) æ•¸å€¼</span>`;
        return;
    }
    
    if (isNaN(tx_power_input) || (tx_power_unit === 'w' && tx_power_input < 0)) {
         output.innerHTML = `æ¥æ”¶è¨Šè™Ÿå¼·åº¦: <span style="color:${redColor};">è«‹è¼¸å…¥æœ‰æ•ˆçš„ç™¼å°„åŠŸç‡</span>`;
         return;
    }

    // 1. è½‰æ›ç™¼å°„åŠŸç‡ç‚º dBm
    const tx_power_dbm = convertPower(tx_power_input, tx_power_unit, 'dbm');

    if (isNaN(tx_power_dbm)) {
         output.innerHTML = `æ¥æ”¶è¨Šè™Ÿå¼·åº¦: <span style="color:${redColor};">ç™¼å°„åŠŸç‡ (W) å¿…é ˆ > 0</span>`;
         return;
    }

    // 2. è¨ˆç®— FSPL (è‡ªç”±ç©ºé–“æè€—)
    // FSPL (dB) = 32.44 + 20 * log10(f_MHz) + 20 * log10(d_km)
    const fspl_db = 32.44 + (20 * Math.log10(freq_mhz)) + (20 * Math.log10(dist_km));
    
    // 3. è¨ˆç®— Link Budget (æ¥æ”¶åŠŸç‡)
    // P_R (dBm) = P_T(dBm) - L_Tx + G_Tx - FSPL + G_Rx - L_Rx
    const rx_power_dbm = tx_power_dbm - tx_loss_db + tx_gain_dbi - fspl_db + rx_gain_dbi - rx_loss_db;
    
    // è¼¸å‡ºæ•¸å€¼
    output.innerHTML = `
        æ¥æ”¶è¨Šè™Ÿå¼·åº¦: <span class="result-value">${rx_power_dbm.toFixed(2)}</span> <span style="color:${unit_color};">dBm</span><br>
        <span style="font-size:14px;color:var(--muted);">
            è·¯å¾‘æè€— (Path Loss): ${fspl_db.toFixed(2)} dB (FSPL) + ${(tx_loss_db + rx_loss_db).toFixed(2)} dB (ç·šæ) = ${(fspl_db + tx_loss_db + rx_loss_db).toFixed(2)} dB<br>
            ç™¼å°„ EIRP: ${(tx_power_dbm - tx_loss_db + tx_gain_dbi).toFixed(2)} dBm
        </span>
    `;
}


// --- åˆå§‹åŒ–åŸ·è¡Œ ---
document.addEventListener('DOMContentLoaded', () => {
    // åˆå§‹è¨ˆç®—æ‰€æœ‰é¡¯ç¤ºçš„å€å¡Š
    toggleSections(); 
});

</script>
</body>
</html>

